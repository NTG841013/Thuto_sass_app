app
globals.css
@import url("https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&display=swap");
@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

:root {
  --primary: oklch(0.205 0 0);

  --cta: #2c2c2c;
  --cta-gold: #fccc41;
  --radius: 0.625rem;
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.145 0 0);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.145 0 0);
  --primary-foreground: oklch(0.985 0 0);
  --secondary: oklch(0.97 0 0);
  --secondary-foreground: oklch(0.205 0 0);
  --muted: oklch(0.97 0 0);
  --muted-foreground: oklch(0.556 0 0);
  --accent: oklch(0.97 0 0);
  --accent-foreground: oklch(0.205 0 0);
  --destructive: oklch(0.577 0.245 27.325);
  --border: oklch(0.922 0 0);
  --input: oklch(0.922 0 0);
  --ring: oklch(0.708 0 0);
  --chart-1: oklch(0.646 0.222 41.116);
  --chart-2: oklch(0.6 0.118 184.704);
  --chart-3: oklch(0.398 0.07 227.392);
  --chart-4: oklch(0.828 0.189 84.429);
  --chart-5: oklch(0.769 0.188 70.08);
  --sidebar: oklch(0.985 0 0);
  --sidebar-foreground: oklch(0.145 0 0);
  --sidebar-primary: oklch(0.205 0 0);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.97 0 0);
  --sidebar-accent-foreground: oklch(0.205 0 0);
  --sidebar-border: oklch(0.922 0 0);
  --sidebar-ring: oklch(0.708 0 0);
  --background: oklch(1 0 0);
  --foreground: oklch(0.145 0 0);
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --color-primary: var(--primary);
  --color-cta: var(--cta);
  --color-cta-gold: var(--cta-gold);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
  --font-bricolage: "Bricolage Grotesque", sans-serif;
  --color-sidebar-ring: var(--sidebar-ring);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar: var(--sidebar);
  --color-chart-5: var(--chart-5);
  --color-chart-4: var(--chart-4);
  --color-chart-3: var(--chart-3);
  --color-chart-2: var(--chart-2);
  --color-chart-1: var(--chart-1);
  --color-ring: var(--ring);
  --color-input: var(--input);
  --color-border: var(--border);
  --color-destructive: var(--destructive);
  --color-accent-foreground: var(--accent-foreground);
  --color-accent: var(--accent);
  --color-muted-foreground: var(--muted-foreground);
  --color-muted: var(--muted);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-secondary: var(--secondary);
  --color-primary-foreground: var(--primary-foreground);
  --color-popover-foreground: var(--popover-foreground);
  --color-popover: var(--popover);
  --color-card-foreground: var(--card-foreground);
  --color-card: var(--card);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
}

body {
  font-family: var(--font-bricolage);
}

.dark {
  --background: oklch(0.145 0 0);
  --foreground: oklch(0.985 0 0);
  --card: oklch(0.205 0 0);
  --card-foreground: oklch(0.985 0 0);
  --popover: oklch(0.205 0 0);
  --popover-foreground: oklch(0.985 0 0);
  --primary: oklch(0.922 0 0);
  --primary-foreground: oklch(0.205 0 0);
  --secondary: oklch(0.269 0 0);
  --secondary-foreground: oklch(0.985 0 0);
  --muted: oklch(0.269 0 0);
  --muted-foreground: oklch(0.708 0 0);
  --accent: oklch(0.269 0 0);
  --accent-foreground: oklch(0.985 0 0);
  --destructive: oklch(0.704 0.191 22.216);
  --border: oklch(1 0 0 / 10%);
  --input: oklch(1 0 0 / 15%);
  --ring: oklch(0.556 0 0);
  --chart-1: oklch(0.488 0.243 264.376);
  --chart-2: oklch(0.696 0.17 162.48);
  --chart-3: oklch(0.769 0.188 70.08);
  --chart-4: oklch(0.627 0.265 303.9);
  --chart-5: oklch(0.645 0.246 16.439);
  --sidebar: oklch(0.205 0 0);
  --sidebar-foreground: oklch(0.985 0 0);
  --sidebar-primary: oklch(0.488 0.243 264.376);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.269 0 0);
  --sidebar-accent-foreground: oklch(0.985 0 0);
  --sidebar-border: oklch(1 0 0 / 10%);
  --sidebar-ring: oklch(0.556 0 0);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }
  main {
    @apply mx-auto px-14 flex flex-col gap-8 bg-background h-full max-w-[1400px] pt-10 max-sm:px-2;
  }
  h1 {
    @apply text-3xl font-bold;
  }
}

@layer components {
  .home-section {
    @apply flex gap-4 justify-between items-start w-full max-lg:flex-col-reverse max-lg:items-center;
  }
  .companions-grid {
    @apply flex flex-wrap gap-4 w-full max-md:justify-center;
  }
  .companion-card {
    @apply flex flex-col rounded-4xl border border-black px-4 py-4 gap-5 w-full min-lg:max-w-[410px] justify-between;
  }
  .subject-badge {
    @apply bg-black text-white rounded-4xl text-sm px-2 py-1 capitalize;
  }
  .companion-bookmark {
    @apply px-2 bg-black rounded-4xl flex items-center h-full aspect-square cursor-pointer;
  }
  .input {
    @apply !border-black !bg-white focus-visible:!ring-0 focus-visible:!border-black !w-full;
  }
  .rounded-border {
    @apply rounded-4xl border border-black;
  }
  .cta-section {
    @apply bg-cta text-white rounded-4xl px-7 py-10 flex flex-col items-center text-center gap-5 w-1/3 max-lg:w-1/2 max-md:w-full;
  }
  .cta-badge {
    @apply bg-cta-gold rounded-4xl px-3 py-1.5 text-black;
  }
  .btn-primary {
    @apply bg-primary text-white rounded-xl cursor-pointer px-4 py-2 flex items-center gap-2;
  }
  .navbar {
    @apply flex items-center justify-between mx-auto w-full px-14 py-4 bg-white max-sm:px-4;
  }
  .btn-signin {
    @apply border border-black rounded-4xl px-4 py-2.5 text-sm font-semibold flex items-center gap-2 cursor-pointer;
  }
  .companion-list {
    @apply rounded-4xl border border-black px-7 pt-7 pb-10 max-lg:w-full bg-white;
  }
  .companion-limit {
    @apply items-center justify-center flex flex-col gap-4 w-full min-2xl:w-1/2 pt-20 text-center;
  }

  .companion-section {
    @apply border-2 border-orange-500 w-2/3 max-sm:w-full flex flex-col gap-4 justify-center items-center rounded-lg;
  }

  .companion-avatar {
    @apply size-[300px] flex items-center justify-center rounded-lg max-sm:size-[100px] mt-4;
  }
  .companion-lottie {
    @apply size-[300px] max-sm:size-[100px];
  }

  .user-section {
    @apply flex flex-col gap-4 w-1/3 max-sm:w-full max-sm:flex-row;
  }
  .user-avatar {
    @apply border-2 border-black flex flex-col gap-4 items-center rounded-lg py-8 max-sm:hidden;
  }

  .btn-mic {
    @apply border-2 border-black rounded-lg flex flex-col gap-2 items-center py-8 max-sm:py-2 cursor-pointer w-full;
  }

  .transcript {
    @apply relative flex flex-col gap-4 w-full items-center pt-10 flex-grow overflow-hidden;
  }
  .transcript-message {
    @apply overflow-y-auto w-full flex flex-col gap-4 max-sm:gap-2 pr-2 h-full text-2xl;
  }
  .transcript-fade {
    @apply pointer-events-none absolute bottom-0 left-0 right-0 h-40 max-sm:h-20 bg-gradient-to-t from-background via-background/90 to-transparent z-10;
  }
}

@layer utilities {
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
}

layout.tsx
import type { Metadata } from "next";
import { Bricolage_Grotesque } from "next/font/google";
import "./globals.css";
import Navbar from "@/components/Navbar";
import {
    ClerkProvider,
} from '@clerk/nextjs'

const bricolage = Bricolage_Grotesque({
  variable: "--font-bricolage",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Thuto",
  description: "AI-Assisted Real-Time Learning Framework",
};

export default function RootLayout({
                                       children,
                                   }: Readonly<{
    children: React.ReactNode;
}>) {
    // Suppress Daily.co transport warnings in development
    if (typeof window !== 'undefined' && process.env.NODE_ENV === 'development') {
        const originalError = console.error;
        console.error = (...args) => {
            if (
                args[0]?.includes?.('transport') &&
                args[0]?.includes?.('disconnected')
            ) {
                return; // Suppress transport disconnect messages
            }
            originalError.apply(console, args);
        };
    }

    return (
        <html lang="en">
        <body className={`${bricolage.variable} antialiased`}>
        <ClerkProvider appearance={{variables: {colorPrimary: '#fe5933'}}}>
            <Navbar/>
            {children}
        </ClerkProvider>
        </body>
        </html>
    );
}

page.tsx
import CompanionCard from "@/components/CompanionCard";
import CompanionsList from "@/components/CompanionsList";
import CTA from "@/components/CTA";
import {recentSessions} from "@/constants";
import {getAllCompanions, getRecentSessions} from "@/lib/actions/companion.actions";
import {getSubjectColor} from "@/lib/utils";

const Page = async () => {
    const companions = await getAllCompanions({ limit: 3 });
    const recentSessionsCompanions = await getRecentSessions(10);

    return (
        <main>
            <h1>Popular Companions</h1>

            <section className="home-section">
                {companions.map((companion) => (
                    <CompanionCard
                        key={companion.id}
                        {...companion}
                        color={getSubjectColor(companion.subject)}
                    />
                ))}

            </section>

            <section className="home-section">
                <CompanionsList
                    title="Recently completed sessions"
                    companions={recentSessionsCompanions}
                    classNames="w-2/3 max-lg:w-full"
                />
                <CTA />
            </section>
        </main>
    )
}

export default Page

api
sentry-example-api
route.ts
import { NextResponse } from "next/server";

export const dynamic = "force-dynamic";
class SentryExampleAPIError extends Error {
  constructor(message: string | undefined) {
    super(message);
    this.name = "SentryExampleAPIError";
  }
}
// A faulty API route to test Sentry's error monitoring
export function GET() {
  throw new SentryExampleAPIError("This error is raised on the backend called by the example page.");
  return NextResponse.json({ data: "Testing Sentry Error..." });
}

companions
page.tsx
import {getAllCompanions, getBookmarkedCompanions} from "@/lib/actions/companion.actions";
import CompanionCard from "@/components/CompanionCard";
import {getSubjectColor} from "@/lib/utils";
import SearchInput from "@/components/SearchInput";
import SubjectFilter from "@/components/SubjectFilter";
import {auth} from "@clerk/nextjs/server";

interface CompanionsLibraryProps {
    searchParams: Promise<{
        subject?: string;
        topic?: string;
    }>;
}

const CompanionsLibrary = async ({ searchParams }: CompanionsLibraryProps) => {
    // âœ… Await the searchParams
    const filters = await searchParams;
    const subject = filters.subject ?? '';
    const topic = filters.topic ?? '';

    const companions = await getAllCompanions({ subject, topic });

    // Get bookmarked companions for the current user
    const { userId } = await auth();
    const bookmarkedCompanions = userId ? await getBookmarkedCompanions(userId) : [];
    const bookmarkedIds = new Set(bookmarkedCompanions.map(c => c.id));

    return (
        <main>
            <section className="flex justify-between gap-4 max-sm:flex-col">
                <h1>Companion Library</h1>
                <div className="flex gap-4">
                    <SearchInput />
                    <SubjectFilter />
                </div>
            </section>
            <section className="companions-grid">
                {companions.length === 0 ? (
                    <div className="col-span-full text-center py-10">
                        <p className="text-gray-500">No companions found. Create your first one!</p>
                    </div>
                ) : (
                    companions.map((companion) => (
                        <CompanionCard
                            key={companion.id}
                            {...companion}
                            color={getSubjectColor(companion.subject)}
                            isBookmarked={bookmarkedIds.has(companion.id)}
                        />
                    ))
                )}
            </section>
        </main>
    )
}

export default CompanionsLibrary

[id]
page.tsx
import { getCompanion } from "@/lib/actions/companion.actions";
import { currentUser } from "@clerk/nextjs/server";
import { redirect } from "next/navigation";
import CompanionComponent from "@/components/CompanionComponent";
import { getSubjectColor } from "@/lib/utils";
import Image from "next/image";

interface CompanionSessionProps {
    params: Promise<{ id: string }>; // âœ… Now a Promise
}

const CompanionSession = async ({ params }: CompanionSessionProps) => {
    // âœ… Await the params
    const { id } = await params;

    const companion = await getCompanion(id);
    const user = await currentUser();

    if (!user) redirect("/sign-in");
    if (!companion) redirect("/companions");

    // âœ… Destructure fields from companion
    const { name, subject, topic, duration } = companion;

    return (
        <main>
            <article className="flex rounded-border justify-between p-6 max-md:flex-col">
                <div className="flex items-center gap-2">
                    <div
                        className="size-[72px] flex items-center justify-center rounded-lg max-md:hidden"
                        style={{ backgroundColor: getSubjectColor(subject) }}
                    >
                        <Image
                            src={`/icons/${subject}.svg`}
                            alt={subject}
                            width={35}
                            height={35}
                        />
                    </div>

                    <div className="flex flex-col gap-2">
                        <div className="flex items-center gap-2">
                            <p className="font-bold text-2xl">{name}</p>
                            <div className="subject-badge max-sm:hidden">{subject}</div>
                        </div>
                        <p className="text-lg">{topic}</p>
                    </div>
                </div>

                <div className="items-start text-2xl max-md:hidden">
                    {duration} minutes
                </div>
            </article>

            {/* âœ… Pass required props to component */}
            <CompanionComponent
                {...companion}
                companionId={id}
                userName={user.firstName ?? "User"}
                userImage={user.imageUrl ?? "/default-avatar.png"}
            />
        </main>
    );
};

export default CompanionSession;

my-journey
page.tsx
import {
    Accordion,
    AccordionContent,
    AccordionItem,
    AccordionTrigger,
} from "@/components/ui/accordion";
import { currentUser } from "@clerk/nextjs/server";
import { redirect } from "next/navigation";
import {
    getUserCompanions,
    getUserSessions,
    getBookmarkedCompanions,
    getUserConversations,
    getConversationStats,
    hasConversationHistoryAccess,
    getAllMonthlyReports,
    generateMonthlyReport,
} from "@/lib/actions/companion.actions";
import Image from "next/image";
import CompanionsList from "@/components/CompanionsList";
import ConversationCard from "@/components/ConversationCard";
import MonthlyReportCard from "@/components/MonthlyReportCard";
import GenerateReportButton from "@/components/GenerateReportButton";
import Link from "next/link";

const Profile = async () => {
    const user = await currentUser();

    if (!user) redirect("/sign-in");

    // Original data
    const companions = await getUserCompanions(user.id);
    const sessionHistory = await getUserSessions(user.id);
    const bookmarkedCompanions = await getBookmarkedCompanions(user.id);

    // Check if user has access to premium features (Core/Pro)
    const hasHistoryAccess = await hasConversationHistoryAccess();

    // New conversation history data (only if has access)
    const conversations = hasHistoryAccess ? await getUserConversations(20, 1, 'asc') : [];

    console.log('ðŸ” Journey page conversations:', {
        count: conversations.length,
        hasAccess: hasHistoryAccess,
        firstThree: conversations.slice(0, 3).map(c => ({
            id: c.id.substring(0, 8),
            created_at: c.created_at,
        })),
    });

    const stats = hasHistoryAccess ? await getConversationStats() : {
        totalConversations: 0,
        totalDuration: 0,
        averageDuration: 0,
        uniqueCompanions: 0,
    };

    // Get monthly reports (only if has access)
    let monthlyReports = hasHistoryAccess ? await getAllMonthlyReports() : [];

    // Auto-generate current month report if doesn't exist and has conversations
    if (hasHistoryAccess && conversations.length > 0) {
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth() + 1;
        const currentYear = currentDate.getFullYear();

        const currentMonthReport = monthlyReports.find(
            r => r.month === currentMonth && r.year === currentYear
        );

        if (!currentMonthReport) {
            try {
                await generateMonthlyReport(currentMonth, currentYear);
                // Refetch reports after generation
                monthlyReports = await getAllMonthlyReports();
            } catch (err) {
                console.error('Failed to generate monthly report:', err);
            }
        }
    }

    return (
        <main className="min-lg:w-3/4">
            <section className="flex justify-between gap-4 max-sm:flex-col items-center">
                <div className="flex gap-4 items-center">
                    <Image
                        src={user.imageUrl}
                        alt={user.firstName!}
                        width={110}
                        height={110}
                        className="rounded-lg"
                    />
                    <div className="flex flex-col gap-2">
                        <h1 className="font-bold text-2xl">
                            {user.firstName} {user.lastName}
                        </h1>
                        <p className="text-sm text-muted-foreground">
                            {user.emailAddresses[0].emailAddress}
                        </p>
                    </div>
                </div>
                <div className="flex gap-4 max-sm:flex-col max-sm:w-full">
                    <div className="border border-black rounded-lg p-3 gap-2 flex flex-col h-fit">
                        <div className="flex gap-2 items-center">
                            <Image
                                src="/icons/check.svg"
                                alt="checkmark"
                                width={22}
                                height={22}
                            />
                            <p className="text-2xl font-bold">{sessionHistory.length}</p>
                        </div>
                        <div>Lessons completed</div>
                    </div>
                    <div className="border border-black rounded-lg p-3 gap-2 flex flex-col h-fit">
                        <div className="flex gap-2 items-center">
                            <Image src="/icons/cap.svg" alt="cap" width={22} height={22} />
                            <p className="text-2xl font-bold">{companions.length}</p>
                        </div>
                        <div>Companions created</div>
                    </div>
                </div>
            </section>

            {/* Statistics Section - Only for Core/Pro users */}
            {hasHistoryAccess && (
                <section className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="rounded-border p-4 bg-white">
                        <p className="text-muted-foreground text-xs mb-1">Total Sessions</p>
                        <p className="text-2xl font-bold">{stats.totalConversations}</p>
                    </div>
                    <div className="rounded-border p-4 bg-white">
                        <p className="text-muted-foreground text-xs mb-1">Total Time</p>
                        <p className="text-2xl font-bold">{Math.round(stats.totalDuration / 60)}m</p>
                    </div>
                    <div className="rounded-border p-4 bg-white">
                        <p className="text-muted-foreground text-xs mb-1">Avg Duration</p>
                        <p className="text-2xl font-bold">{stats.averageDuration}s</p>
                    </div>
                    <div className="rounded-border p-4 bg-white">
                        <p className="text-muted-foreground text-xs mb-1">Companions Used</p>
                        <p className="text-2xl font-bold">{stats.uniqueCompanions}</p>
                    </div>
                </section>
            )}

            <Accordion type="multiple" defaultValue={hasHistoryAccess ? ["reports", "conversations"] : []}>
                {/* Monthly Reports Section - Only for Core/Pro users */}
                {hasHistoryAccess ? (
                    <AccordionItem value="reports">
                        <AccordionTrigger className="text-2xl font-bold">
                            Monthly Reports {monthlyReports.length > 0 && `(${monthlyReports.length})`}
                        </AccordionTrigger>
                        <AccordionContent>
                            <div className="mb-4">
                                <GenerateReportButton />
                            </div>
                            {monthlyReports.length === 0 ? (
                                <div className="rounded-border p-10 text-center bg-white">
                                    <p className="text-muted-foreground">
                                        No monthly reports yet. Complete some sessions to generate your first report!
                                    </p>
                                </div>
                            ) : (
                                <div className="flex flex-col gap-4">
                                    {monthlyReports.map((report) => (
                                        <MonthlyReportCard
                                            key={report.id}
                                            report={report}
                                        />
                                    ))}
                                </div>
                            )}
                        </AccordionContent>
                    </AccordionItem>
                ) : (
                    <AccordionItem value="reports" className="border-2 border-cta-gold">
                        <AccordionTrigger className="text-2xl font-bold">
                            <div className="flex items-center gap-2">
                                Monthly Reports
                                <span className="cta-badge text-xs">Core/Pro</span>
                            </div>
                        </AccordionTrigger>
                        <AccordionContent>
                            <div className="rounded-border p-10 text-center bg-white flex flex-col items-center gap-4">
                                <div className="cta-badge">Premium Feature</div>
                                <h3 className="text-xl font-bold">Unlock Monthly Progress Reports</h3>
                                <p className="text-muted-foreground max-w-md">
                                    Get detailed monthly insights into your learning journey. Track subjects studied, time spent, and your progress over time.
                                </p>
                                <Link href="/subscription" className="btn-primary">
                                    Upgrade to Core or Pro
                                </Link>
                            </div>
                        </AccordionContent>
                    </AccordionItem>
                )}

                {/* Conversation History Section - Only for Core/Pro users */}
                {hasHistoryAccess ? (
                    <AccordionItem value="conversations">
                        <AccordionTrigger className="text-2xl font-bold">
                            Conversation History {conversations.length > 0 && `(${conversations.length})`}
                        </AccordionTrigger>
                        <AccordionContent>
                            {conversations.length === 0 ? (
                                <div className="rounded-border p-10 text-center bg-white">
                                    <p className="text-muted-foreground">
                                        No conversations yet. Start a session to see your history here!
                                    </p>
                                </div>
                            ) : (
                                <div className="flex flex-col gap-4">
                                    {/* Display in ascending order (oldest first) */}
                                    {conversations.map((conversation) => (
                                        <ConversationCard
                                            key={conversation.id}
                                            conversation={conversation}
                                        />
                                    ))}
                                </div>
                            )}
                        </AccordionContent>
                    </AccordionItem>
                ) : (
                    <AccordionItem value="conversations" className="border-2 border-cta-gold">
                        <AccordionTrigger className="text-2xl font-bold">
                            <div className="flex items-center gap-2">
                                Conversation History
                                <span className="cta-badge text-xs">Core/Pro</span>
                            </div>
                        </AccordionTrigger>
                        <AccordionContent>
                            <div className="rounded-border p-10 text-center bg-white flex flex-col items-center gap-4">
                                <div className="cta-badge">Premium Feature</div>
                                <h3 className="text-xl font-bold">Unlock Conversation History</h3>
                                <p className="text-muted-foreground max-w-md">
                                    Save and review your learning conversations. Track your progress with detailed statistics and transcripts.
                                </p>
                                <Link href="/subscription" className="btn-primary">
                                    Upgrade to Core or Pro
                                </Link>
                            </div>
                        </AccordionContent>
                    </AccordionItem>
                )}

                {/* Original Sections */}
                <AccordionItem value="bookmarks">
                    <AccordionTrigger className="text-2xl font-bold">
                        Bookmarked Companions {`(${bookmarkedCompanions.length})`}
                    </AccordionTrigger>
                    <AccordionContent>
                        {bookmarkedCompanions.length === 0 ? (
                            <div className="rounded-border p-10 text-center bg-white">
                                <p className="text-muted-foreground">
                                    No bookmarked companions yet.
                                </p>
                            </div>
                        ) : (
                            <CompanionsList
                                companions={bookmarkedCompanions}
                                title="Bookmarked Companions"
                            />
                        )}
                    </AccordionContent>
                </AccordionItem>

                <AccordionItem value="recent">
                    <AccordionTrigger className="text-2xl font-bold">
                        Recent Sessions {`(${sessionHistory.length})`}
                    </AccordionTrigger>
                    <AccordionContent>
                        {sessionHistory.length === 0 ? (
                            <div className="rounded-border p-10 text-center bg-white">
                                <p className="text-muted-foreground">
                                    No recent sessions yet.
                                </p>
                            </div>
                        ) : (
                            <CompanionsList
                                title="Recent Sessions"
                                companions={sessionHistory}
                            />
                        )}
                    </AccordionContent>
                </AccordionItem>

                <AccordionItem value="companions">
                    <AccordionTrigger className="text-2xl font-bold">
                        My Companions {`(${companions.length})`}
                    </AccordionTrigger>
                    <AccordionContent>
                        {companions.length === 0 ? (
                            <div className="rounded-border p-10 text-center bg-white">
                                <p className="text-muted-foreground">
                                    You haven't created any companions yet.
                                </p>
                            </div>
                        ) : (
                            <CompanionsList title="My Companions" companions={companions} />
                        )}
                    </AccordionContent>
                </AccordionItem>
            </Accordion>
        </main>
    );
};

export default Profile;

new
page.tsx
import CompanionForm from "@/components/CompanionForm";
import {redirect} from "next/navigation";
import Image from "next/image";
import Link from "next/link";
import {newCompanionPermissions} from "@/lib/actions/companion.actions";
import {auth} from "@clerk/nextjs/server";

const NewCompanion = async () => {
    const { userId } = await auth();
    if(!userId) redirect('/sign-in');

    const canCreateCompanion = await newCompanionPermissions();

    return (
        <main className="min-lg:w-1/3 min-md:w-2/3 items-center justify-center">
            {canCreateCompanion ? (
                <article className="w-full gap-4 flex flex-col">
                    <h1>Companion Builder</h1>

                    <CompanionForm />
                </article>
            ) : (
                <article className="companion-limit">
                    <Image src="/images/limit.svg" alt="Companion limit reached" width={360} height={230} />
                    <div className="cta-badge">
                        Upgrade your plan
                    </div>
                    <h1>Youâ€™ve Reached Your Limit</h1>
                    <p>Youâ€™ve reached your companion limit. Upgrade to create more companions and premium features.</p>
                    <Link href="/subscription" className="btn-primary w-full justify-center" >
                        Upgrade My Plan
                    </Link>
                </article>
            )}
        </main>
    )
}

export default NewCompanion

dashboard
page.tsx
import { currentUser } from "@clerk/nextjs/server";
import { redirect } from "next/navigation";
import { auth } from "@clerk/nextjs/server";
import {
    getConversationStats,
    getAllMonthlyReports,
    getUserConversations,
    getLearningReminders,
} from "@/lib/actions/companion.actions";
import Link from "next/link";
import PerformanceCharts from "@/components/PerformanceCharts";
import LearningInsights from "@/components/LearningInsights";
import SubjectBreakdown from "@/components/SubjectBreakdown";
import DailyReminders from "@/components/DailyReminders";

const PerformanceDashboard = async () => {
    const user = await currentUser();
    if (!user) redirect("/sign-in");

    // Check if user is Pro
    const { has } = await auth();
    const isProUser = has({ plan: 'pro' });

    if (!isProUser) {
        return (
            <main className="min-lg:w-3/4">
                <div className="flex flex-col items-center justify-center min-h-[60vh] text-center gap-6">
                    <div className="rounded-full bg-cta-gold p-6">
                        <svg
                            className="w-16 h-16"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={2}
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                            />
                        </svg>
                    </div>
                    <div>
                        <h1 className="text-3xl font-bold mb-4">Pro Feature</h1>
                        <p className="text-muted-foreground max-w-md mb-6">
                            The Performance Dashboard is an exclusive feature for Pro members.
                            Upgrade to unlock advanced analytics, insights, and personalized learning metrics.
                        </p>
                        <div className="flex flex-col gap-3 items-center">
                            <Link href="/subscription" className="btn-primary px-8">
                                Upgrade to Pro
                            </Link>
                            <Link href="/companions/my-journey" className="text-sm text-muted-foreground hover:underline">
                                Return to My Journey
                            </Link>
                        </div>
                    </div>
                </div>
            </main>
        );
    }

    // Get all data for Pro users
    const stats = await getConversationStats();
    const monthlyReports = await getAllMonthlyReports();
    const recentConversations = await getUserConversations(10, 1, 'desc');
    const reminderSettings = await getLearningReminders();

    console.log('ðŸ“Š Dashboard data:', {
        statsLoaded: !!stats,
        reportsCount: monthlyReports.length,
        conversationsCount: recentConversations.length,
        reminderSettings,
    });

    // Calculate additional metrics
    const totalHours = Math.round(stats.totalDuration / 3600 * 10) / 10;
    const averageSessionMinutes = Math.round(stats.averageDuration / 60);

    // Get learning streak
    const learningStreak = calculateLearningStreak(recentConversations);

    // Get subject performance
    const subjectPerformance = calculateSubjectPerformance(monthlyReports);

    return (
        <main className="min-lg:w-3/4">
            <div className="flex justify-between items-center mb-6">
                <div>
                    <h1 className="text-3xl font-bold">Performance Dashboard</h1>
                    <p className="text-muted-foreground">Track your learning progress and insights</p>
                </div>
                <div className="cta-badge">Pro</div>
            </div>

            {/* Key Metrics */}
            <section className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div className="rounded-border p-6 bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
                    <p className="text-sm text-blue-700 mb-1">Total Sessions</p>
                    <p className="text-4xl font-bold text-blue-900">{stats.totalConversations}</p>
                </div>
                <div className="rounded-border p-6 bg-gradient-to-br from-green-50 to-green-100 border-green-200">
                    <p className="text-sm text-green-700 mb-1">Learning Hours</p>
                    <p className="text-4xl font-bold text-green-900">{totalHours}h</p>
                </div>
                <div className="rounded-border p-6 bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200">
                    <p className="text-sm text-purple-700 mb-1">Avg Session</p>
                    <p className="text-4xl font-bold text-purple-900">{averageSessionMinutes}m</p>
                </div>
                <div className="rounded-border p-6 bg-gradient-to-br from-orange-50 to-orange-100 border-orange-200">
                    <p className="text-sm text-orange-700 mb-1">Learning Streak</p>
                    <p className="text-4xl font-bold text-orange-900">{learningStreak} days</p>
                </div>
            </section>

            {/* Charts */}
            <PerformanceCharts monthlyReports={monthlyReports} conversations={recentConversations} />

            {/* Subject Breakdown */}
            <SubjectBreakdown subjectPerformance={subjectPerformance} />

            {/* Daily Reminders - Full Width Section */}
            <section className="mb-8">
                <DailyReminders initialSettings={reminderSettings ? {
                    enabled: reminderSettings.enabled,
                    time: reminderSettings.reminder_time,
                    frequency: reminderSettings.frequency,
                    customDays: reminderSettings.custom_days,
                } : undefined} />
            </section>

            {/* Learning Insights */}
            <LearningInsights
                stats={stats}
                monthlyReports={monthlyReports}
                recentConversations={recentConversations}
            />
        </main>
    );
};

// Helper functions
function calculateLearningStreak(conversations: any[]): number {
    if (conversations.length === 0) return 0;

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    let streak = 0;
    let currentDate = new Date(today);

    for (let i = 0; i < 30; i++) { // Check last 30 days
        const hasSession = conversations.some(conv => {
            const convDate = new Date(conv.created_at);
            convDate.setHours(0, 0, 0, 0);
            return convDate.getTime() === currentDate.getTime();
        });

        if (hasSession) {
            streak++;
        } else if (streak > 0) {
            break; // Streak broken
        }

        currentDate.setDate(currentDate.getDate() - 1);
    }

    return streak;
}

function calculateSubjectPerformance(monthlyReports: any[]) {
    const subjects: Record<string, { sessions: number; duration: number; completion: number }> = {};

    monthlyReports.forEach(report => {
        if (report.report_data?.subjectsStudied) {
            Object.entries(report.report_data.subjectsStudied).forEach(([subject, data]: [string, any]) => {
                if (!subjects[subject]) {
                    subjects[subject] = { sessions: 0, duration: 0, completion: 0 };
                }
                subjects[subject].sessions += data.sessions || 0;
                subjects[subject].duration += data.totalDuration || 0;
                subjects[subject].completion += data.completionPercentage || 0;
            });
        }
    });

    // Calculate averages
    Object.keys(subjects).forEach(subject => {
        const reportCount = monthlyReports.filter(r =>
            r.report_data?.subjectsStudied?.[subject]
        ).length;
        if (reportCount > 0) {
            subjects[subject].completion = Math.round(subjects[subject].completion / reportCount);
        }
    });

    return subjects;
}

export default PerformanceDashboard;

sentry-example-page
page.tsx
"use client";

import Head from "next/head";
import * as Sentry from "@sentry/nextjs";
import { useState, useEffect } from "react";

class SentryExampleFrontendError extends Error {
  constructor(message: string | undefined) {
    super(message);
    this.name = "SentryExampleFrontendError";
  }
}

export default function Page() {
  const [hasSentError, setHasSentError] = useState(false);
  const [isConnected, setIsConnected] = useState(true);
  
  useEffect(() => {
    async function checkConnectivity() {
      const result = await Sentry.diagnoseSdkConnectivity();
      setIsConnected(result !== 'sentry-unreachable');
    }
    checkConnectivity();
  }, []);

  return (
    <div>
      <Head>
        <title>sentry-example-page</title>
        <meta name="description" content="Test Sentry for your Next.js app!" />
      </Head>

      <main>
        <div className="flex-spacer" />
        <svg height="40" width="40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21.85 2.995a3.698 3.698 0 0 1 1.353 1.354l16.303 28.278a3.703 3.703 0 0 1-1.354 5.053 3.694 3.694 0 0 1-1.848.496h-3.828a31.149 31.149 0 0 0 0-3.09h3.815a.61.61 0 0 0 .537-.917L20.523 5.893a.61.61 0 0 0-1.057 0l-3.739 6.494a28.948 28.948 0 0 1 9.63 10.453 28.988 28.988 0 0 1 3.499 13.78v1.542h-9.852v-1.544a19.106 19.106 0 0 0-2.182-8.85 19.08 19.08 0 0 0-6.032-6.829l-1.85 3.208a15.377 15.377 0 0 1 6.382 12.484v1.542H3.696A3.694 3.694 0 0 1 0 34.473c0-.648.17-1.286.494-1.849l2.33-4.074a8.562 8.562 0 0 1 2.689 1.536L3.158 34.17a.611.611 0 0 0 .538.917h8.448a12.481 12.481 0 0 0-6.037-9.09l-1.344-.772 4.908-8.545 1.344.77a22.16 22.16 0 0 1 7.705 7.444 22.193 22.193 0 0 1 3.316 10.193h3.699a25.892 25.892 0 0 0-3.811-12.033 25.856 25.856 0 0 0-9.046-8.796l-1.344-.772 5.269-9.136a3.698 3.698 0 0 1 3.2-1.849c.648 0 1.285.17 1.847.495Z" fill="currentcolor"/>
        </svg>
        <h1>
          sentry-example-page
        </h1>

        <p className="description">
          Click the button below, and view the sample error on the Sentry <a target="_blank" href="https://the-collective-4l.sentry.io/issues/?project=4510353927241808">Issues Page</a>.
          For more details about setting up Sentry, <a target="_blank"
           href="https://docs.sentry.io/platforms/javascript/guides/nextjs/">read our docs</a>.
        </p>

        <button
          type="button"
          onClick={async () => {
            await Sentry.startSpan({
              name: 'Example Frontend/Backend Span',
              op: 'test'
            }, async () => {
              const res = await fetch("/api/sentry-example-api");
              if (!res.ok) {
                setHasSentError(true);
              }
            });
            throw new SentryExampleFrontendError("This error is raised on the frontend of the example page.");
          }}
          disabled={!isConnected}
        >
          <span>
            Throw Sample Error
          </span>
        </button>

        {hasSentError ? (
          <p className="success">
            Error sent to Sentry.
          </p>
        ) : !isConnected ? (
          <div className="connectivity-error">
            <p>It looks like network requests to Sentry are being blocked, which will prevent errors from being captured. Try disabling your ad-blocker to complete the test.</p>
          </div>
        ) : (
          <div className="success_placeholder" />
        )}

        <div className="flex-spacer" />
      
      </main>

      <style>{`
        main {
          display: flex;
          min-height: 100vh;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          gap: 16px;
          padding: 16px;
          font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
        }

        h1 {
          padding: 0px 4px;
          border-radius: 4px;
          background-color: rgba(24, 20, 35, 0.03);
          font-family: monospace;
          font-size: 20px;
          line-height: 1.2;
        }

        p {
          margin: 0;
          font-size: 20px;
        }

        a {
          color: #6341F0;
          text-decoration: underline;
          cursor: pointer;

          @media (prefers-color-scheme: dark) {
            color: #B3A1FF;
          }
        }

        button {
          border-radius: 8px;
          color: white;
          cursor: pointer;
          background-color: #553DB8;
          border: none;
          padding: 0;
          margin-top: 4px;

          & > span {
            display: inline-block;
            padding: 12px 16px;
            border-radius: inherit;
            font-size: 20px;
            font-weight: bold;
            line-height: 1;
            background-color: #7553FF;
            border: 1px solid #553DB8;
            transform: translateY(-4px);
          }

          &:hover > span {
            transform: translateY(-8px);
          }

          &:active > span {
            transform: translateY(0);
          }

          &:disabled {
	            cursor: not-allowed;
	            opacity: 0.6;
	
	            & > span {
	              transform: translateY(0);
	              border: none
	            }
	          }
        }

        .description {
          text-align: center;
          color: #6E6C75;
          max-width: 500px;
          line-height: 1.5;
          font-size: 20px;

          @media (prefers-color-scheme: dark) {
            color: #A49FB5;
          }
        }

        .flex-spacer {
          flex: 1;
        }

        .success {
          padding: 12px 16px;
          border-radius: 8px;
          font-size: 20px;
          line-height: 1;
          background-color: #00F261;
          border: 1px solid #00BF4D;
          color: #181423;
        }

        .success_placeholder {
          height: 46px;
        }

        .connectivity-error {
          padding: 12px 16px;
          background-color: #E50045;
          border-radius: 8px;
          width: 500px;
          color: #FFFFFF;
          border: 1px solid #A80033;
          text-align: center;
          margin: 0;
        }
        
        .connectivity-error a {
          color: #FFFFFF;
          text-decoration: underline;
        }
      `}</style>
    </div>
  );
}

sign-in
[[...sign-in]]
page.tsx
import { SignIn } from "@clerk/nextjs";

export default function Page() {
    return <main className="flex justify-center items-center">
        <SignIn />;
    </main>
}

subscription
import {PricingTable} from "@clerk/nextjs";

const Subscription = () => {
    return (
        <main>
            <PricingTable />
        </main>
    )
}
export default Subscription

components
CompanionCard.tsx
'use client';

import Image from "next/image";
import Link from "next/link";
import { useState, useTransition } from "react";
import { addBookmark, removeBookmark } from "@/lib/actions/companion.actions";
import { usePathname } from "next/navigation";

interface CompanionCardProps {
    id: string;
    name: string;
    topic: string;
    subject: string;
    duration: number;
    color: string;
    isBookmarked?: boolean;
}

const CompanionCard = ({id, name, topic, subject, duration, color, isBookmarked = false}: CompanionCardProps) => {
    const [bookmarked, setBookmarked] = useState(isBookmarked);
    const [isPending, startTransition] = useTransition();
    const pathname = usePathname();

    const handleBookmark = async (e: React.MouseEvent) => {
        e.preventDefault(); // Prevent Link navigation
        e.stopPropagation();

        startTransition(async () => {
            try {
                if (bookmarked) {
                    await removeBookmark(id, pathname);
                    setBookmarked(false);
                } else {
                    await addBookmark(id, pathname);
                    setBookmarked(true);
                }
            } catch (error) {
                console.error('Error toggling bookmark:', error);
            }
        });
    };

    return (
        <article className="companion-card" style={{ backgroundColor: color}}>
            <div className="flex justify-between items-center">
                <div className="subject-badge">{subject}</div>
                <button
                    className="companion-bookmark"
                    onClick={handleBookmark}
                    disabled={isPending}
                    aria-label={bookmarked ? "Remove bookmark" : "Add bookmark"}
                >
                    <Image
                        src={bookmarked ? "/icons/bookmark-filled.svg" : "/icons/bookmark.svg"}
                        alt="bookmark"
                        width={24}
                        height={24}
                        className={isPending ? "opacity-50" : ""}
                    />
                </button>
            </div>
            <h2 className="text-2xl font-bold">{name}</h2>
            <p className="text-sm">{topic}</p>
            <div className="flex items-center gap-2">
                <Image src="/icons/clock.svg" alt="duration" width={13.5} height={13.5} />
                <p className="text-sm">{duration} minutes</p>
            </div>
            <Link href={`/companions/${id}`} className="w-full">
                <button className="btn-primary w-full justify-center">
                    Launch Lesson
                </button>
            </Link>
        </article>
    )
}

export default CompanionCard

CompanionComponent.tsx
'use client';

import {useEffect, useRef, useState} from 'react'
import {cn, configureAssistant, getSubjectColor} from "@/lib/utils";
import {vapi} from "@/lib/vapi.sdk";
import Image from "next/image";
import Lottie, {LottieRefCurrentProps} from "lottie-react";
import soundwaves from '@/constants/soundwaves.json'
import {addToSessionHistory, saveConversationHistory} from "@/lib/actions/companion.actions";

enum CallStatus {
    INACTIVE = 'INACTIVE',
    CONNECTING = 'CONNECTING',
    ACTIVE = 'ACTIVE',
    FINISHED = 'FINISHED',
}

const CompanionComponent = ({ companionId, subject, topic, name, userName, userImage, style, voice }: CompanionComponentProps) => {
    const [callStatus, setCallStatus] = useState<CallStatus>(CallStatus.INACTIVE);
    const [isSpeaking, setIsSpeaking] = useState(false);
    const [isMuted, setIsMuted] = useState(false);
    const [messages, setMessages] = useState<SavedMessage[]>([]);
    const [error, setError] = useState<string | null>(null);
    const [sessionId, setSessionId] = useState<string | null>(null);
    const [callStartTime, setCallStartTime] = useState<number | null>(null);

    // âœ… Use a ref to store messages so they're not lost during state updates
    const messagesRef = useRef<SavedMessage[]>([]);
    // âœ… Also use ref for callStartTime to ensure it persists
    const callStartTimeRef = useRef<number | null>(null);

    const lottieRef = useRef<LottieRefCurrentProps>(null);
    const isConnectingRef = useRef(false);

    useEffect(() => {
        if(lottieRef.current) {
            if(isSpeaking) {
                lottieRef.current.play()
            } else {
                lottieRef.current.stop()
            }
        }
    }, [isSpeaking]);

    useEffect(() => {
        const onCallStart = () => {
            console.log('âœ… Call started successfully');
            const startTime = Date.now();
            setCallStatus(CallStatus.ACTIVE);
            setError(null);
            isConnectingRef.current = false;
            setCallStartTime(startTime);
            callStartTimeRef.current = startTime; // âœ… Store in ref too
            console.log('â±ï¸ Call start time set:', startTime);
        };

        const onCallEnd = async () => {
            console.log('âœ… Call ended successfully');

            // âœ… Get duration from ref (more reliable than state)
            const startTime = callStartTimeRef.current;
            const endTime = Date.now();
            const duration = startTime ? Math.round((endTime - startTime) / 1000) : 0;

            console.log('â±ï¸ Duration calculation:', {
                startTime,
                endTime,
                duration,
                callStartTimeState: callStartTime,
            });

            // âœ… Use messagesRef to get the actual messages, not state
            const savedMessages = messagesRef.current;

            console.log('ðŸ“Š Call ended with:', {
                duration,
                messageCount: savedMessages.length,
                companionId,
            });

            // Update UI state
            setCallStatus(CallStatus.FINISHED);
            isConnectingRef.current = false;

            try {
                // Add to session history with duration
                console.log('ðŸ’¾ Saving session history with duration:', duration);
                const session = await addToSessionHistory(companionId, duration);
                console.log('âœ… Session history saved:', JSON.stringify(session, null, 2));

                const currentSessionId = session?.[0]?.id;

                if (!currentSessionId) {
                    console.error('âŒ No session ID returned from addToSessionHistory');
                    return;
                }

                // Save conversation history if there are messages
                if (savedMessages.length > 0) {
                    console.log('ðŸ’¾ Saving conversation history...', {
                        sessionId: currentSessionId,
                        companionId,
                        messageCount: savedMessages.length,
                        duration,
                    });

                    const conversationResult = await saveConversationHistory({
                        sessionId: currentSessionId,
                        companionId,
                        messages: savedMessages,
                        duration,
                    });

                    console.log('âœ… Conversation saved successfully:', JSON.stringify(conversationResult, null, 2));
                } else {
                    console.warn('âš ï¸ No messages to save');
                }
            } catch (err) {
                console.error('âŒ Failed to save conversation:', err);
                setError('Failed to save conversation history');
            }
        }

        const onMessage = (message: Message) => {
            if(message.type === 'transcript' && message.transcriptType === 'final') {
                const newMessage = { role: message.role, content: message.transcript }
                setMessages((prev) => {
                    const updated = [newMessage, ...prev];
                    messagesRef.current = updated; // âœ… Also update ref
                    return updated;
                });
            }
        }

        const onSpeechStart = () => setIsSpeaking(true);
        const onSpeechEnd = () => setIsSpeaking(false);

        const onError = (error: Error) => {
            // Ignore transport disconnection errors (normal behavior when call ends)
            const errorMessage = error.message || error.toString();
            if (errorMessage.includes('transport') && errorMessage.includes('disconnected')) {
                console.log('â„¹ï¸ Transport disconnected (call ended normally)');
                return;
            }

            console.error('âŒ VAPI Error:', error);
            setError(error.message || 'An error occurred with the voice assistant');
            setCallStatus(CallStatus.INACTIVE);
            isConnectingRef.current = false;
        };

        vapi.on('call-start', onCallStart);
        vapi.on('call-end', onCallEnd);
        vapi.on('message', onMessage);
        vapi.on('error', onError);
        vapi.on('speech-start', onSpeechStart);
        vapi.on('speech-end', onSpeechEnd);

        return () => {
            vapi.off('call-start', onCallStart);
            vapi.off('call-end', onCallEnd);
            vapi.off('message', onMessage);
            vapi.off('error', onError);
            vapi.off('speech-start', onSpeechStart);
            vapi.off('speech-end', onSpeechEnd);
        }
    }, [companionId]);

    const toggleMicrophone = () => {
        if (callStatus !== CallStatus.ACTIVE) return;

        try {
            const currentlyMuted = vapi.isMuted();
            vapi.setMuted(!currentlyMuted);
            setIsMuted(!currentlyMuted);
        } catch (err) {
            console.error('Error toggling microphone:', err);
            setError('Failed to toggle microphone');
        }
    }

    const handleCall = async () => {
        // Prevent multiple simultaneous connection attempts
        if (isConnectingRef.current) {
            console.log('Already connecting, ignoring duplicate call');
            return;
        }

        try {
            setError(null);
            setCallStatus(CallStatus.CONNECTING);
            isConnectingRef.current = true;

            console.log('Starting call with config:', { subject, topic, style, voice });

            const assistantConfig = configureAssistant(voice, style);

            const assistantOverrides = {
                variableValues: { subject, topic, style },
                clientMessages: ["transcript"],
                serverMessages: [],
            };

            console.log('Assistant config:', assistantConfig);
            console.log('Assistant overrides:', assistantOverrides);

            // Start the VAPI call
            await vapi.start(assistantConfig, assistantOverrides);

        } catch (err) {
            console.error('Error starting call:', err);
            setError(err instanceof Error ? err.message : 'Failed to start session');
            setCallStatus(CallStatus.INACTIVE);
            isConnectingRef.current = false;
        }
    }

    const handleDisconnect = () => {
        try {
            console.log('ðŸ›‘ User manually disconnected');
            console.log('ðŸ“Š Current state:', {
                messageCount: messages.length,
                callStartTime,
                callStartTimeRef: callStartTimeRef.current,
                duration: callStartTimeRef.current ? Math.round((Date.now() - callStartTimeRef.current) / 1000) : 0,
            });
            setCallStatus(CallStatus.FINISHED);
            vapi.stop();
            isConnectingRef.current = false;
        } catch (err) {
            console.error('Error stopping call:', err);
        }
    }

    // Debug function to check current state
    const logCurrentState = () => {
        console.log('ðŸ” Current Component State:', {
            callStatus,
            messageCount: messages.length,
            messagesRefCount: messagesRef.current.length,
            messages: messages,
            messagesRef: messagesRef.current,
            companionId,
            callStartTime,
            callStartTimeRef: callStartTimeRef.current,
            duration: callStartTimeRef.current ? Math.round((Date.now() - callStartTimeRef.current) / 1000) : 0,
        });
    };

    return (
        <section className="flex flex-col h-[70vh]">
            {error && (
                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
                    <p className="font-semibold">Error:</p>
                    <p className="text-sm">{error}</p>
                </div>
            )}

            <section className="flex gap-8 max-sm:flex-col">
                <div className="companion-section">
                    <div className="companion-avatar" style={{ backgroundColor: getSubjectColor(subject)}}>
                        <div
                            className={
                                cn(
                                    'absolute transition-opacity duration-1000',
                                    callStatus === CallStatus.FINISHED || callStatus === CallStatus.INACTIVE ? 'opacity-100' : 'opacity-0',
                                    callStatus === CallStatus.CONNECTING && 'opacity-100 animate-pulse'
                                )
                            }>
                            <Image
                                src={`/icons/${subject}.svg`}
                                alt={subject}
                                width={150}
                                height={150}
                                className="max-sm:w-fit"
                            />
                        </div>

                        <div className={cn('absolute transition-opacity duration-1000', callStatus === CallStatus.ACTIVE ? 'opacity-100': 'opacity-0')}>
                            <Lottie
                                lottieRef={lottieRef}
                                animationData={soundwaves}
                                autoplay={false}
                                className="companion-lottie"
                            />
                        </div>
                    </div>
                    <p className="font-bold text-2xl">{name}</p>
                    {callStatus === CallStatus.CONNECTING && (
                        <p className="text-sm text-gray-600">Connecting to voice assistant...</p>
                    )}
                </div>

                <div className="user-section">
                    <div className="user-avatar">
                        <Image
                            src={userImage}
                            alt={userName}
                            width={130}
                            height={130}
                            className="rounded-lg"
                        />
                        <p className="font-bold text-2xl">
                            {userName}
                        </p>
                    </div>
                    <button
                        className="btn-mic"
                        onClick={toggleMicrophone}
                        disabled={callStatus !== CallStatus.ACTIVE}
                    >
                        <Image
                            src={isMuted ? '/icons/mic-off.svg' : '/icons/mic-on.svg'}
                            alt="mic"
                            width={36}
                            height={36}
                        />
                        <p className="max-sm:hidden">
                            {isMuted ? 'Turn on microphone' : 'Turn off microphone'}
                        </p>
                    </button>
                    <button
                        className={cn(
                            'rounded-lg py-2 cursor-pointer transition-colors w-full text-white',
                            callStatus === CallStatus.ACTIVE ? 'bg-red-700' : 'bg-primary',
                            callStatus === CallStatus.CONNECTING && 'animate-pulse opacity-75 cursor-not-allowed'
                        )}
                        onClick={callStatus === CallStatus.ACTIVE ? handleDisconnect : handleCall}
                        disabled={callStatus === CallStatus.CONNECTING}
                    >
                        {callStatus === CallStatus.ACTIVE
                            ? "End Session"
                            : callStatus === CallStatus.CONNECTING
                                ? 'Connecting...'
                                : 'Start Session'
                        }
                    </button>
                </div>
            </section>

            <section className="transcript">
                {/* Debug info - Remove in production */}
                {process.env.NODE_ENV === 'development' && (
                    <div className="text-xs text-gray-500 mb-2">
                        Debug: {messages.length} messages | Status: {callStatus} | Duration: {callStartTime ? Math.round((Date.now() - callStartTime) / 1000) : 0}s
                        <button onClick={logCurrentState} className="ml-2 underline">Log State</button>
                    </div>
                )}

                <div className="transcript-message no-scrollbar">
                    {messages.length === 0 && callStatus === CallStatus.ACTIVE && (
                        <p className="text-gray-500 text-center">Conversation will appear here...</p>
                    )}
                    {messages.map((message, index) => {
                        if(message.role === 'assistant') {
                            return (
                                <p key={index} className="max-sm:text-sm">
                                    {name.split(' ')[0].replace(/[.,]/g, '')}: {message.content}
                                </p>
                            )
                        } else {
                            return (
                                <p key={index} className="text-primary max-sm:text-sm">
                                    {userName}: {message.content}
                                </p>
                            )
                        }
                    })}
                </div>

                <div className="transcript-fade" />
            </section>
        </section>
    )
}

export default CompanionComponent

CompanionForm.tsx
"use client";

import React, { useState } from "react";
import { useForm, SubmitHandler, Controller, type Resolver } from "react-hook-form";
import { z } from "zod";
import { zodResolver } from "@hookform/resolvers/zod";
import { createCompanion } from "@/lib/actions/companion.actions";
import { useRouter } from "next/navigation";

/**
 * 1) Schema: coerce to number so browser strings => number
 */
const formSchema = z.object({
    name: z.string().min(1, "Name is required"),
    subject: z.string().min(1, "Subject is required"),
    topic: z.string().min(1, "Topic is required"),
    voice: z.string().min(1, "Voice is required"),
    style: z.string().min(1, "Style is required"),
    duration: z.coerce.number().min(1, "Duration must be at least 1"),
});

/**
 * 2) Single source of truth for form types
 */
type FormValues = z.infer<typeof formSchema>;

/**
 * 3) Create resolver and assert its type explicitly
 */
const typedResolver = zodResolver(formSchema) as unknown as Resolver<FormValues, any>;

export default function CompanionForm() {
    const router = useRouter();
    const [error, setError] = useState<string | null>(null);

    const {
        register,
        handleSubmit,
        control,
        formState: { errors, isSubmitting },
        reset,
    } = useForm<FormValues>({
        resolver: typedResolver,
        defaultValues: {
            name: "",
            subject: "",
            topic: "",
            voice: "",
            style: "",
            duration: 30,
        },
    });

    const onSubmit: SubmitHandler<FormValues> = async (values) => {
        try {
            setError(null);

            // Call the server action to create companion
            const companion = await createCompanion(values);

            if (companion && companion.id) {
                // Reset form
                reset();

                // Redirect to the newly created companion page
                router.push(`/companions/${companion.id}`);
            }
        } catch (err) {
            console.error("Error creating companion:", err);
            setError(err instanceof Error ? err.message : "Failed to create companion");
        }
    };

    return (
        <form onSubmit={handleSubmit(onSubmit)} className="flex flex-col gap-4">
            {error && (
                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
                    {error}
                </div>
            )}

            <label className="flex flex-col gap-2">
                <span className="text-sm font-medium">Companion Name</span>
                <input
                    {...register("name")}
                    className="rounded-4xl border border-black bg-white px-4 py-2.5 w-full focus:outline-none focus:ring-2 focus:ring-black/20"
                    placeholder="e.g., Math Master Mike"
                />
                {errors.name && <p className="text-red-500 text-sm">{errors.name.message}</p>}
            </label>

            <label className="flex flex-col gap-2">
                <span className="text-sm font-medium">Subject</span>
                <select
                    {...register("subject")}
                    className="rounded-4xl border border-black bg-white px-4 py-2.5 w-full focus:outline-none focus:ring-2 focus:ring-black/20 appearance-none"
                >
                    <option value="">Select subject</option>
                    <option value="maths">Maths</option>
                    <option value="science">Science</option>
                    <option value="language">Language</option>
                    <option value="history">History</option>
                    <option value="coding">Coding</option>
                    <option value="economics">Economics</option>
                </select>
                {errors.subject && <p className="text-red-500 text-sm">{errors.subject.message}</p>}
            </label>

            <label className="flex flex-col gap-2">
                <span className="text-sm font-medium">Topic</span>
                <textarea
                    {...register("topic")}
                    className="rounded-4xl border border-black bg-white px-4 py-2.5 w-full focus:outline-none focus:ring-2 focus:ring-black/20 resize-none min-h-[80px]"
                    placeholder="e.g., Derivatives & Integrals"
                    rows={3}
                />
                {errors.topic && <p className="text-red-500 text-sm">{errors.topic.message}</p>}
            </label>

            <label className="flex flex-col gap-2">
                <span className="text-sm font-medium">Voice</span>
                <select
                    {...register("voice")}
                    className="rounded-4xl border border-black bg-white px-4 py-2.5 w-full focus:outline-none focus:ring-2 focus:ring-black/20 appearance-none"
                >
                    <option value="">Select voice</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
                {errors.voice && <p className="text-red-500 text-sm">{errors.voice.message}</p>}
            </label>

            <label className="flex flex-col gap-2">
                <span className="text-sm font-medium">Teaching Style</span>
                <select
                    {...register("style")}
                    className="rounded-4xl border border-black bg-white px-4 py-2.5 w-full focus:outline-none focus:ring-2 focus:ring-black/20 appearance-none"
                >
                    <option value="">Select style</option>
                    <option value="casual">Casual</option>
                    <option value="formal">Formal</option>
                </select>
                {errors.style && <p className="text-red-500 text-sm">{errors.style.message}</p>}
            </label>

            <label className="flex flex-col gap-2">
                <span className="text-sm font-medium">Duration (minutes)</span>
                <Controller
                    name="duration"
                    control={control}
                    render={({ field }) => (
                        <input
                            type="number"
                            min={1}
                            {...field}
                            className="rounded-4xl border border-black bg-white px-4 py-2.5 w-full focus:outline-none focus:ring-2 focus:ring-black/20"
                        />
                    )}
                />
                {errors.duration && <p className="text-red-500 text-sm">{errors.duration.message}</p>}
            </label>

            <button
                type="submit"
                disabled={isSubmitting}
                className="btn-primary w-full justify-center mt-4"
            >
                {isSubmitting ? "Creating..." : "Create Companion"}
            </button>
        </form>
    );
}

CompanionsList.tsx

import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from "@/components/ui/table"
import {cn, getSubjectColor} from "@/lib/utils";
import Link from "next/link";
import Image from "next/image";

interface CompanionsListProps {
    title: string;
    companions?: Companion[];
    classNames?: string;
}

const CompanionsList = ({ title, companions, classNames }: CompanionsListProps) => {
    return (
        <article className={cn('companion-list', classNames)}>
            <h2 className="font-bold text-3xl">{title}</h2>

            <Table>
                <TableHeader>
                    <TableRow>
                        <TableHead className="text-lg w-2/3">Lessons</TableHead>
                        <TableHead className="text-lg">Subject</TableHead>
                        <TableHead className="text-lg text-right">Duration</TableHead>
                    </TableRow>
                </TableHeader>
                <TableBody>
                    {companions?.map(({id, subject, name, topic, duration}) => (
                        <TableRow key={id}>
                            <TableCell>
                                <Link href={`/companions/${id}`}>
                                    <div className="flex items-center gap-2">
                                        <div className="size-[72px] flex items-center justify-center rounded-lg max-md:hidden" style={{ backgroundColor: getSubjectColor(subject) }}>
                                            <Image
                                                src={`/icons/${subject}.svg`}
                                                alt={subject}
                                                width={35}
                                                height={35} />
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <p className="font-bold text-2xl">
                                                {name}
                                            </p>
                                            <p className="text-lg">
                                                {topic}
                                            </p>
                                        </div>
                                    </div>
                                </Link>
                            </TableCell>
                            <TableCell>
                                <div className="subject-badge w-fit max-md:hidden">
                                    {subject}
                                </div>
                                <div className="flex items-center justify-center rounded-lg w-fit p-2 md:hidden" style={{backgroundColor: getSubjectColor(subject)}}>
                                    <Image
                                        src={`/icons/${subject}.svg`}
                                        alt={subject}
                                        width={18}
                                        height={18}
                                    />
                                </div>
                            </TableCell>
                            <TableCell>
                                <div className="flex items-center gap-2 w-full justify-end">
                                    <p className="text-2xl">
                                        {duration} {' '}
                                        <span className="max-md:hidden">mins</span>
                                    </p>
                                    <Image src="/icons/clock.svg" alt="minutes" width={14} height={14} className="md:hidden" />
                                </div>
                            </TableCell>
                        </TableRow>
                    ))}
                </TableBody>
            </Table>
        </article>
    )
}

export default CompanionsList;

ConversationCard.tsx
'use client';

import { useState } from "react";
import Image from "next/image";
import Link from "next/link";
import { getSubjectColor } from "@/lib/utils";
import { deleteConversation } from "@/lib/actions/companion.actions";
import { usePathname } from "next/navigation";

interface ConversationCardProps {
    conversation: {
        id: string;
        created_at: string;
        duration: number;
        messages: Array<{ role: string; content: string }>;
        companions: {
            id: string;
            name: string;
            subject: string;
            topic: string;
        };
    };
}

const ConversationCard = ({ conversation }: ConversationCardProps) => {
    const [isExpanded, setIsExpanded] = useState(false);
    const [isDeleting, setIsDeleting] = useState(false);
    const pathname = usePathname();

    const { companions, messages, duration, created_at } = conversation;
    const messageCount = messages.length;
    const date = new Date(created_at).toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
    });

    const handleDelete = async () => {
        if (!confirm('Are you sure you want to delete this conversation?')) return;

        setIsDeleting(true);
        try {
            await deleteConversation(conversation.id, pathname);
        } catch (error) {
            console.error('Error deleting conversation:', error);
            alert('Failed to delete conversation');
        } finally {
            setIsDeleting(false);
        }
    };

    return (
        <article className="rounded-border p-6 bg-white">
            <div className="flex justify-between items-start gap-4">
                <div className="flex items-center gap-4 flex-1">
                    <div
                        className="size-16 flex items-center justify-center rounded-lg shrink-0"
                        style={{ backgroundColor: getSubjectColor(companions.subject) }}
                    >
                        <Image
                            src={`/icons/${companions.subject}.svg`}
                            alt={companions.subject}
                            width={30}
                            height={30}
                        />
                    </div>

                    <div className="flex flex-col gap-1 flex-1 min-w-0">
                        <Link
                            href={`/companions/${companions.id}`}
                            className="font-bold text-xl hover:underline truncate"
                        >
                            {companions.name}
                        </Link>
                        <p className="text-sm text-muted-foreground truncate">{companions.topic}</p>
                        <div className="flex items-center gap-4 text-sm text-muted-foreground flex-wrap">
                            <span>{date}</span>
                            <span>â€¢</span>
                            <span>{messageCount} messages</span>
                            <span>â€¢</span>
                            <span>{duration ? `${Math.round(duration / 60)}m ${duration % 60}s` : 'N/A'}</span>
                        </div>
                    </div>
                </div>

                <div className="flex items-center gap-2 shrink-0">
                    <button
                        onClick={() => setIsExpanded(!isExpanded)}
                        className="px-3 py-2 rounded-lg border border-black hover:bg-gray-50 text-sm"
                    >
                        {isExpanded ? 'Hide' : 'View'}
                    </button>
                    <button
                        onClick={handleDelete}
                        disabled={isDeleting}
                        className="px-3 py-2 rounded-lg border border-red-500 text-red-500 hover:bg-red-50 text-sm disabled:opacity-50"
                    >
                        {isDeleting ? 'Deleting...' : 'Delete'}
                    </button>
                </div>
            </div>

            {isExpanded && (
                <div className="mt-4 pt-4 border-t border-gray-200">
                    <h3 className="font-semibold mb-3">Conversation</h3>
                    <div className="flex flex-col gap-3 max-h-96 overflow-y-auto">
                        {messages.map((message, index) => (
                            <div
                                key={index}
                                className={`p-3 rounded-lg ${
                                    message.role === 'assistant'
                                        ? 'bg-gray-100'
                                        : 'bg-primary/10 ml-8'
                                }`}
                            >
                                <p className="text-xs font-semibold mb-1 text-muted-foreground">
                                    {message.role === 'assistant' ? companions.name : 'You'}
                                </p>
                                <p className="text-sm">{message.content}</p>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </article>
    );
};

export default ConversationCard;

CTA.tsx
import React from 'react'
import Image from 'next/image'
import Link from 'next/link'

const Cta = () => {
    return (
        <section className="cta-section">
            <div className="cta-badge">Discover the joy of learning, your way</div>
            <h2 className="text-3xl font-bold">
                Start your journey with Thuto today and unlock the power of AI-assisted learning.
            </h2>
            <p>Create your learning partner â€” pick a name, voice, and subject, and dive into fun, natural conversations.</p>
            <Image src="/images/cta.svg" alt="cta" width={362} height={232} />
            <button className="btn-primary">
                <Image src="/icons/plus.svg" alt="plus" width={12} height={12} />
                <Link href="/companions/new">
                    <p>Create your new learning buddy</p>
                </Link>

            </button>

        </section>
    )
}
export default Cta

DailyReminders.tsx
'use client';

import { useState, useEffect } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { saveLearningReminders } from "@/lib/actions/companion.actions";
import { useRouter } from "next/navigation";

interface DailyRemindersProps {
    initialSettings?: {
        enabled: boolean;
        time: string;
        frequency: 'daily' | 'weekdays' | 'custom';
        customDays?: string[];
    };
}

const DailyReminders = ({ initialSettings }: DailyRemindersProps) => {
    const router = useRouter();
    const [enabled, setEnabled] = useState(initialSettings?.enabled ?? false);
    const [time, setTime] = useState(initialSettings?.time ?? '09:00');
    const [frequency, setFrequency] = useState<'daily' | 'weekdays' | 'custom'>(
        initialSettings?.frequency ?? 'daily'
    );
    const [isSaving, setIsSaving] = useState(false);
    const [saved, setSaved] = useState(false);

    // Sync with initialSettings when they change
    useEffect(() => {
        if (initialSettings) {
            setEnabled(initialSettings.enabled);
            setTime(initialSettings.time || '09:00');
            setFrequency(initialSettings.frequency || 'daily');
        }
    }, [initialSettings]);

    const handleSave = async () => {
        setIsSaving(true);
        setSaved(false);

        try {
            console.log('ðŸ’¾ Saving reminder settings:', { enabled, time, frequency });

            await saveLearningReminders({
                enabled,
                time,
                frequency,
            });

            console.log('âœ… Reminder settings saved successfully');
            setSaved(true);
            router.refresh();

            setTimeout(() => setSaved(false), 3000);
        } catch (error) {
            console.error('âŒ Failed to save reminders:', error);
            alert('Failed to save settings. Please try again.');
        } finally {
            setIsSaving(false);
        }
    };

    // Auto-save when enabled/disabled
    const handleToggle = async (newEnabled: boolean) => {
        setEnabled(newEnabled);
        setIsSaving(true);

        try {
            console.log('ðŸ”„ Auto-saving toggle state:', newEnabled);

            await saveLearningReminders({
                enabled: newEnabled,
                time,
                frequency,
            });

            console.log('âœ… Toggle state saved');
            router.refresh();
        } catch (error) {
            console.error('âŒ Failed to save toggle:', error);
            // Revert on error
            setEnabled(!newEnabled);
        } finally {
            setIsSaving(false);
        }
    };

    return (
        <Card className="border-2 border-primary/20">
            <CardHeader>
                <div className="flex items-center justify-between">
                    <div>
                        <CardTitle className="flex items-center gap-2">
                            <span>ðŸ“…</span>
                            Daily Learning Reminders
                        </CardTitle>
                        <CardDescription>
                            Get notified to maintain your learning streak
                        </CardDescription>
                    </div>
                    <div className="flex items-center space-x-2">
                        <Switch
                            id="reminders-toggle"
                            checked={enabled}
                            onCheckedChange={handleToggle}
                            disabled={isSaving}
                        />
                        <Label htmlFor="reminders-toggle" className="cursor-pointer">
                            {enabled ? 'On' : 'Off'}
                        </Label>
                    </div>
                </div>
            </CardHeader>

            {enabled && (
                <CardContent className="space-y-6">
                    {/* Time Selection */}
                    <div className="space-y-2">
                        <Label htmlFor="reminder-time">Reminder Time</Label>
                        <input
                            id="reminder-time"
                            type="time"
                            value={time}
                            onChange={(e) => setTime(e.target.value)}
                            className="w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                        <p className="text-xs text-muted-foreground">
                            Choose when you'd like to receive your daily reminder
                        </p>
                    </div>

                    {/* Frequency Selection */}
                    <div className="space-y-2">
                        <Label htmlFor="reminder-frequency">Frequency</Label>
                        <Select value={frequency} onValueChange={(value: any) => setFrequency(value)}>
                            <SelectTrigger id="reminder-frequency">
                                <SelectValue placeholder="Select frequency" />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="daily">Every Day</SelectItem>
                                <SelectItem value="weekdays">Weekdays Only</SelectItem>
                            </SelectContent>
                        </Select>
                        <p className="text-xs text-muted-foreground">
                            {frequency === 'daily' && 'Get reminders 7 days a week'}
                            {frequency === 'weekdays' && 'Get reminders Monday through Friday'}
                        </p>
                    </div>

                    {/* Preview */}
                    <div className="rounded-lg border border-muted bg-muted/50 p-4">
                        <p className="text-sm font-medium mb-2">Preview:</p>
                        <div className="flex items-center gap-3 text-sm text-muted-foreground">
                            <span className="text-2xl">ðŸ””</span>
                            <div>
                                <p className="font-medium text-foreground">
                                    Time to learn with Thuto!
                                </p>
                                <p className="text-xs">
                                    Your daily learning session at {formatTime(time)}
                                </p>
                            </div>
                        </div>
                    </div>

                    {/* Save Button */}
                    <div className="flex items-center gap-3">
                        <Button
                            onClick={handleSave}
                            disabled={isSaving}
                            className="flex-1"
                        >
                            {isSaving ? 'Saving...' : 'Save Settings'}
                        </Button>
                        {saved && (
                            <span className="text-sm text-green-600 font-medium">
                                âœ“ Saved!
                            </span>
                        )}
                    </div>

                    <p className="text-xs text-muted-foreground">
                        ðŸ’¡ Note: Reminders will be sent via email. Make sure your email preferences are configured.
                    </p>
                </CardContent>
            )}
        </Card>
    );
};

function formatTime(time: string): string {
    const [hours, minutes] = time.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour % 12 || 12;
    return `${displayHour}:${minutes} ${ampm}`;
}

export default DailyReminders;

GenerateReportButton.tsx
'use client';

import { useState } from "react";
import { generateMonthlyReport } from "@/lib/actions/companion.actions";
import { useRouter } from "next/navigation";

const GenerateReportButton = () => {
    const [isGenerating, setIsGenerating] = useState(false);
    const router = useRouter();

    const handleGenerate = async () => {
        setIsGenerating(true);
        try {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1;
            const currentYear = currentDate.getFullYear();

            await generateMonthlyReport(currentMonth, currentYear);
            router.refresh();
        } catch (error) {
            console.error('Error generating report:', error);
            alert('Failed to generate report. Please try again.');
        } finally {
            setIsGenerating(false);
        }
    };

    return (
        <button
            onClick={handleGenerate}
            disabled={isGenerating}
            className="btn-primary text-sm"
        >
            {isGenerating ? 'Generating...' : 'Generate Current Month Report'}
        </button>
    );
};

export default GenerateReportButton;

LearningInsights.tsx
'use client';

interface LearningInsightsProps {
    stats: {
        totalConversations: number;
        totalDuration: number;
        averageDuration: number;
        uniqueCompanions: number;
    };
    monthlyReports: any[];
    recentConversations: any[];
}

const LearningInsights = ({ stats, monthlyReports, recentConversations }: LearningInsightsProps) => {
    const insights = generateInsights(stats, monthlyReports, recentConversations);

    return (
        <section className="rounded-border p-6 bg-white">
            <h3 className="font-bold text-xl mb-4">AI-Powered Insights</h3>
            <div className="grid md:grid-cols-2 gap-4">
                {insights.positive.length > 0 && (
                    <div className="border border-green-200 bg-green-50 rounded-lg p-4">
                        <div className="flex items-center gap-2 mb-3">
                            <span className="text-2xl">ðŸŽ‰</span>
                            <h4 className="font-semibold text-green-800">Achievements</h4>
                        </div>
                        <ul className="space-y-2">
                            {insights.positive.map((insight, idx) => (
                                <li key={idx} className="text-sm text-green-700 flex items-start gap-2">
                                    <span className="mt-0.5">â€¢</span>
                                    <span>{insight}</span>
                                </li>
                            ))}
                        </ul>
                    </div>
                )}

                {insights.recommendations.length > 0 && (
                    <div className="border border-blue-200 bg-blue-50 rounded-lg p-4">
                        <div className="flex items-center gap-2 mb-3">
                            <span className="text-2xl">ðŸ’¡</span>
                            <h4 className="font-semibold text-blue-800">Recommendations</h4>
                        </div>
                        <ul className="space-y-2">
                            {insights.recommendations.map((insight, idx) => (
                                <li key={idx} className="text-sm text-blue-700 flex items-start gap-2">
                                    <span className="mt-0.5">â€¢</span>
                                    <span>{insight}</span>
                                </li>
                            ))}
                        </ul>
                    </div>
                )}
            </div>

            {/* Learning Patterns */}
            {insights.patterns.length > 0 && (
                <div className="mt-4 border border-purple-200 bg-purple-50 rounded-lg p-4">
                    <div className="flex items-center gap-2 mb-3">
                        <span className="text-2xl">ðŸ“Š</span>
                        <h4 className="font-semibold text-purple-800">Learning Patterns</h4>
                    </div>
                    <ul className="space-y-2">
                        {insights.patterns.map((pattern, idx) => (
                            <li key={idx} className="text-sm text-purple-700 flex items-start gap-2">
                                <span className="mt-0.5">â€¢</span>
                                <span>{pattern}</span>
                            </li>
                        ))}
                    </ul>
                </div>
            )}
        </section>
    );
};

function generateInsights(stats: any, monthlyReports: any[], recentConversations: any[]) {
    const positive: string[] = [];
    const recommendations: string[] = [];
    const patterns: string[] = [];

    // Achievements
    if (stats.totalConversations >= 50) {
        positive.push(`Amazing! You've completed ${stats.totalConversations} learning sessions.`);
    } else if (stats.totalConversations >= 20) {
        positive.push(`Great progress! ${stats.totalConversations} sessions completed.`);
    }

    const totalHours = stats.totalDuration / 3600;
    if (totalHours >= 10) {
        positive.push(`You've invested ${Math.round(totalHours)} hours in learning!`);
    }

    if (stats.uniqueCompanions >= 5) {
        positive.push(`Exploring diverse topics with ${stats.uniqueCompanions} different companions.`);
    }

    // Recommendations
    if (stats.averageDuration < 300) { // Less than 5 minutes
        recommendations.push('Try extending your sessions to 10-15 minutes for better retention.');
    }

    if (recentConversations.length < 3) {
        recommendations.push('Stay consistent! Aim for at least 3 sessions per week.');
    }

    const lastMonthReport = monthlyReports[0];
    if (lastMonthReport?.report_data?.subjectsStudied) {
        const subjects = Object.keys(lastMonthReport.report_data.subjectsStudied);
        if (subjects.length === 1) {
            recommendations.push('Diversify your learning by exploring other subjects.');
        }
    }

    if (stats.totalConversations > 0 && stats.uniqueCompanions < 3) {
        recommendations.push('Try different companions to discover new learning styles.');
    }

    // Patterns
    if (recentConversations.length >= 7) {
        const daysWithSessions = new Set(
            recentConversations.map(c => new Date(c.created_at).toDateString())
        );
        if (daysWithSessions.size >= 5) {
            patterns.push('You\'re building a strong daily learning habit!');
        }
    }

    if (monthlyReports.length >= 2) {
        const current = monthlyReports[0]?.total_sessions || 0;
        const previous = monthlyReports[1]?.total_sessions || 0;
        if (current > previous) {
            const growth = Math.round(((current - previous) / previous) * 100);
            patterns.push(`Your session count increased by ${growth}% this month!`);
        }
    }

    return { positive, recommendations, patterns };
}

export default LearningInsights;

MonthlyReportCard.tsx
'use client';

interface MonthlyReportCardProps {
    report: {
        id: string;
        month: number;
        year: number;
        total_sessions: number;
        total_duration: number;
        subjects_studied: Record<string, number>;
        report_data: {
            totalSessions: number;
            totalDuration: number;
            averageDuration: number;
            mostStudiedSubject?: string;
            strengths?: string[];
            areasForImprovement?: string[];
            subjectsStudied: Record<string, {
                sessions: number;
                totalDuration: number;
                expectedDuration: number;
                completionPercentage: number;
                companions: string[];
            }>;
        };
    };
}

const monthNames = [
    'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
];

const MonthlyReportCard = ({ report }: MonthlyReportCardProps) => {
    const { month, year, total_sessions, total_duration, report_data } = report;
    const monthName = monthNames[month - 1];

    return (
        <article className="rounded-border p-6 bg-white">
            <div className="flex justify-between items-start mb-4">
                <div>
                    <h3 className="text-2xl font-bold">{monthName} {year}</h3>
                    <p className="text-sm text-muted-foreground">Monthly Progress Report</p>
                </div>
                <div className="cta-badge">Report</div>
            </div>

            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div className="border border-gray-200 rounded-lg p-3">
                    <p className="text-xs text-muted-foreground mb-1">Sessions</p>
                    <p className="text-2xl font-bold">{total_sessions}</p>
                </div>
                <div className="border border-gray-200 rounded-lg p-3">
                    <p className="text-xs text-muted-foreground mb-1">Total Time</p>
                    <p className="text-2xl font-bold">{Math.round(total_duration / 60)}m</p>
                </div>
                <div className="border border-gray-200 rounded-lg p-3">
                    <p className="text-xs text-muted-foreground mb-1">Avg Duration</p>
                    <p className="text-2xl font-bold">{report_data.averageDuration}s</p>
                </div>
                <div className="border border-gray-200 rounded-lg p-3">
                    <p className="text-xs text-muted-foreground mb-1">Top Subject</p>
                    <p className="text-lg font-bold capitalize">
                        {report_data.mostStudiedSubject || 'N/A'}
                    </p>
                </div>
            </div>

            {Object.keys(report_data.subjectsStudied).length > 0 && (
                <>
                    <div>
                        <h4 className="font-semibold mb-3">Subjects Studied</h4>
                        <div className="flex flex-col gap-3">
                            {Object.entries(report_data.subjectsStudied)
                                .sort((a, b) => b[1].sessions - a[1].sessions)
                                .map(([subject, data]) => {
                                    const completedSeconds = data.totalDuration;
                                    const expectedSeconds = data.expectedDuration;
                                    const remainingSeconds = Math.max(0, expectedSeconds - completedSeconds);

                                    // Format time to show minutes and seconds
                                    const formatTime = (seconds: number) => {
                                        const mins = Math.floor(seconds / 60);
                                        const secs = seconds % 60;
                                        if (mins === 0) return `${secs}s`;
                                        if (secs === 0) return `${mins}m`;
                                        return `${mins}m ${secs}s`;
                                    };

                                    return (
                                        <div
                                            key={subject}
                                            className="border border-gray-200 rounded-lg p-4"
                                        >
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <p className="font-semibold capitalize text-lg">{subject}</p>
                                                    <p className="text-sm text-muted-foreground">
                                                        {data.sessions} {data.sessions === 1 ? 'session' : 'sessions'}
                                                    </p>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-2xl font-bold text-primary">
                                                        {data.completionPercentage}%
                                                    </p>
                                                    <p className="text-xs text-muted-foreground">Complete</p>
                                                </div>
                                            </div>

                                            {/* Progress bar */}
                                            <div className="w-full bg-gray-200 rounded-full h-2 mb-2">
                                                <div
                                                    className="bg-primary h-2 rounded-full transition-all"
                                                    style={{ width: `${Math.min(data.completionPercentage, 100)}%` }}
                                                />
                                            </div>

                                            <div className="flex justify-between text-sm">
                                            <span className="text-muted-foreground">
                                                <span className="font-medium text-foreground">{formatTime(completedSeconds)}</span> completed
                                            </span>
                                                {remainingSeconds > 0 && (
                                                    <span className="text-muted-foreground">
                                                    <span className="font-medium text-foreground">{formatTime(remainingSeconds)}</span> remaining
                                                </span>
                                                )}
                                            </div>

                                            {data.companions && data.companions.length > 0 && (
                                                <div className="mt-2 pt-2 border-t border-gray-100">
                                                    <p className="text-xs text-muted-foreground mb-1">Companions:</p>
                                                    <div className="flex flex-wrap gap-1">
                                                        {data.companions.map((companion, idx) => (
                                                            <span key={idx} className="text-xs bg-gray-100 px-2 py-0.5 rounded">
                                                            {companion}
                                                        </span>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                        </div>
                    </div>

                    {/* Strengths and Areas for Improvement */}
                    {(report_data.strengths || report_data.areasForImprovement) && (
                        <div className="grid md:grid-cols-2 gap-4 mt-6">
                            {report_data.strengths && report_data.strengths.length > 0 && (
                                <div className="border border-green-200 bg-green-50 rounded-lg p-4">
                                    <h4 className="font-semibold text-green-800 mb-2">ðŸ’ª Strengths</h4>
                                    <ul className="space-y-1">
                                        {report_data.strengths.map((strength, idx) => (
                                            <li key={idx} className="text-sm text-green-700">â€¢ {strength}</li>
                                        ))}
                                    </ul>
                                </div>
                            )}
                            {report_data.areasForImprovement && report_data.areasForImprovement.length > 0 && (
                                <div className="border border-blue-200 bg-blue-50 rounded-lg p-4">
                                    <h4 className="font-semibold text-blue-800 mb-2">ðŸ“ˆ Areas for Growth</h4>
                                    <ul className="space-y-1">
                                        {report_data.areasForImprovement.map((area, idx) => (
                                            <li key={idx} className="text-sm text-blue-700">â€¢ {area}</li>
                                        ))}
                                    </ul>
                                </div>
                            )}
                        </div>
                    )}
                </>
            )}
        </article>
    );
};

export default MonthlyReportCard;

Navbar.tsx
'use client';

import React from 'react'
import Link from 'next/link'
import Image from 'next/image'
import NavItems from "@/components/NavItems";
import {
    SignInButton,
    SignedIn,
    SignedOut,
    UserButton,
} from '@clerk/nextjs'

const Navbar = () => {
    return (
        <nav className="navbar">
            <Link href="/">
                <div className="flex items-center gap-2.5 cursor-pointer">
                    <Image
                        src="/images/logo.svg"
                        alt="logo"
                        width={46}
                        height={44}
                    />
                </div>
            </Link>
            <div className="flex items-center gap-8">
                <NavItems/>
                <SignedOut>
                    <SignInButton>
                        <button className="btn-signin">Sign In</button>
                    </SignInButton>
                </SignedOut>
                <SignedIn>
                    <UserButton afterSignOutUrl="/" />
                </SignedIn>
            </div>
        </nav>
    )
}

export default Navbar

NavItems.tsx
'use client'

import Link from "next/link"
import {usePathname} from "next/navigation";
import {cn} from "@/lib/utils";

const navItems = [
    {label: "Home", href: "/"},
    {label: "Companions", href: "/companions"},
    {label: "My Journey", href: "/companions/my-journey"},
    {label: "Dashboard", href: "/dashboard"}, // Add this
]

const NavItems = () => {

    const pathname = usePathname()
    return (
        <nav className="flex items-center gap-4">
            {navItems.map(({label, href}) => (
                <Link href={href}
                      key={label}
                      className={cn(pathname === href && "text-primary font-semibold")}>
                    {label}

                </Link>
            ))}

        </nav>
    )
}
export default NavItems

PerformanceCharts.tsx
'use client';

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { ChartContainer, ChartTooltip, ChartTooltipContent } from "@/components/ui/chart";
import { Area, AreaChart, Bar, BarChart, CartesianGrid, Line, LineChart, XAxis, YAxis } from "recharts";

interface PerformanceChartsProps {
    monthlyReports: any[];
    conversations: any[];
}

const PerformanceCharts = ({ monthlyReports, conversations }: PerformanceChartsProps) => {
    // Prepare monthly progress data
    const monthlyData = monthlyReports.slice(0, 6).reverse().map(report => ({
        month: `${getMonthName(report.month)}`,
        sessions: report.total_sessions,
        hours: Math.round(report.total_duration / 3600 * 10) / 10,
    }));

    // Prepare weekly activity data
    const weeklyData = prepareWeeklyData(conversations);

    // Prepare subject distribution
    const subjectData = prepareSubjectData(monthlyReports);

    const chartConfig = {
        sessions: {
            label: "Sessions",
            color: "hsl(var(--chart-1))",
        },
        hours: {
            label: "Hours",
            color: "hsl(var(--chart-2))",
        },
    };

    return (
        <div className="grid gap-6 mb-8">
            {/* Monthly Progress - Full Width */}
            <Card>
                <CardHeader>
                    <CardTitle>Monthly Progress</CardTitle>
                    <CardDescription>Your learning journey over the last 6 months</CardDescription>
                </CardHeader>
                <CardContent>
                    {monthlyData.length > 0 ? (
                        <ChartContainer config={chartConfig} className="h-[300px]">
                            <AreaChart data={monthlyData}>
                                <defs>
                                    <linearGradient id="colorSessions" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="hsl(var(--chart-1))" stopOpacity={0.8}/>
                                        <stop offset="95%" stopColor="hsl(var(--chart-1))" stopOpacity={0.1}/>
                                    </linearGradient>
                                    <linearGradient id="colorHours" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="hsl(var(--chart-2))" stopOpacity={0.8}/>
                                        <stop offset="95%" stopColor="hsl(var(--chart-2))" stopOpacity={0.1}/>
                                    </linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
                                <XAxis dataKey="month" className="text-xs" />
                                <YAxis className="text-xs" />
                                <ChartTooltip content={<ChartTooltipContent />} />
                                <Area
                                    type="monotone"
                                    dataKey="sessions"
                                    stroke="hsl(var(--chart-1))"
                                    fill="url(#colorSessions)"
                                    strokeWidth={2}
                                />
                                <Area
                                    type="monotone"
                                    dataKey="hours"
                                    stroke="hsl(var(--chart-2))"
                                    fill="url(#colorHours)"
                                    strokeWidth={2}
                                />
                            </AreaChart>
                        </ChartContainer>
                    ) : (
                        <div className="h-[300px] flex items-center justify-center text-muted-foreground">
                            No data available yet. Complete some sessions to see your progress!
                        </div>
                    )}
                </CardContent>
            </Card>

            {/* Weekly Activity & Subject Distribution */}
            <div className="grid md:grid-cols-2 gap-6">
                {/* Weekly Activity */}
                <Card>
                    <CardHeader>
                        <CardTitle>Weekly Activity</CardTitle>
                        <CardDescription>Sessions this week</CardDescription>
                    </CardHeader>
                    <CardContent>
                        {weeklyData.length > 0 ? (
                            <ChartContainer config={chartConfig} className="h-[250px]">
                                <BarChart data={weeklyData}>
                                    <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
                                    <XAxis dataKey="day" className="text-xs" />
                                    <YAxis className="text-xs" />
                                    <ChartTooltip content={<ChartTooltipContent />} />
                                    <Bar
                                        dataKey="sessions"
                                        fill="hsl(var(--chart-3))"
                                        radius={[8, 8, 0, 0]}
                                    />
                                </BarChart>
                            </ChartContainer>
                        ) : (
                            <div className="h-[250px] flex items-center justify-center text-muted-foreground">
                                No activity this week yet
                            </div>
                        )}
                    </CardContent>
                </Card>

                {/* Subject Distribution */}
                <Card>
                    <CardHeader>
                        <CardTitle>Subject Focus</CardTitle>
                        <CardDescription>Time spent per subject</CardDescription>
                    </CardHeader>
                    <CardContent>
                        {subjectData.length > 0 ? (
                            <ChartContainer config={chartConfig} className="h-[250px]">
                                <BarChart data={subjectData} layout="vertical">
                                    <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
                                    <XAxis type="number" className="text-xs" />
                                    <YAxis
                                        dataKey="subject"
                                        type="category"
                                        className="text-xs capitalize"
                                        width={80}
                                    />
                                    <ChartTooltip content={<ChartTooltipContent />} />
                                    <Bar
                                        dataKey="minutes"
                                        fill="hsl(var(--chart-4))"
                                        radius={[0, 8, 8, 0]}
                                    />
                                </BarChart>
                            </ChartContainer>
                        ) : (
                            <div className="h-[250px] flex items-center justify-center text-muted-foreground">
                                No subject data yet
                            </div>
                        )}
                    </CardContent>
                </Card>
            </div>
        </div>
    );
};

function getMonthName(month: number): string {
    const names = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return names[month - 1];
}

function prepareWeeklyData(conversations: any[]) {
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const today = new Date();
    const weekData = days.map((day, index) => ({
        day,
        sessions: 0,
        date: new Date(today.getFullYear(), today.getMonth(), today.getDate() - (6 - index)),
    }));

    conversations.forEach(conv => {
        const convDate = new Date(conv.created_at);
        const daysDiff = Math.floor((today.getTime() - convDate.getTime()) / (1000 * 60 * 60 * 24));

        if (daysDiff >= 0 && daysDiff < 7) {
            const dayIndex = convDate.getDay();
            weekData[dayIndex].sessions++;
        }
    });

    return weekData.map(({ day, sessions }) => ({ day, sessions }));
}

function prepareSubjectData(monthlyReports: any[]) {
    const subjects: Record<string, number> = {};

    monthlyReports.forEach(report => {
        if (report.report_data?.subjectsStudied) {
            Object.entries(report.report_data.subjectsStudied).forEach(([subject, data]: [string, any]) => {
                subjects[subject] = (subjects[subject] || 0) + (data.totalDuration || 0);
            });
        }
    });

    return Object.entries(subjects)
        .map(([subject, duration]) => ({
            subject,
            minutes: Math.round(duration / 60),
        }))
        .sort((a, b) => b.minutes - a.minutes)
        .slice(0, 5); // Top 5 subjects
}

export default PerformanceCharts;

SearchInput.tsx
'use client';

import {usePathname, useRouter, useSearchParams} from "next/navigation";
import {useEffect, useState} from "react";
import Image from "next/image";
import {formUrlQuery, removeKeysFromUrlQuery} from "@jsmastery/utils";

const SearchInput = () => {
    const pathname = usePathname();
    const router = useRouter();
    const searchParams = useSearchParams();
    const query = searchParams.get('topic') || '';

    const [searchQuery, setSearchQuery] = useState('');

    useEffect(() => {
        const delayDebounceFn = setTimeout(() => {
            if(searchQuery) {
                const newUrl = formUrlQuery({
                    params: searchParams.toString(),
                    key: "topic",
                    value: searchQuery,
                });

                router.push(newUrl, { scroll: false });
            } else {
                if(pathname === '/companions') {
                    const newUrl = removeKeysFromUrlQuery({
                        params: searchParams.toString(),
                        keysToRemove: ["topic"],
                    });

                    router.push(newUrl, { scroll: false });
                }
            }
        }, 500)
    }, [searchQuery, router, searchParams, pathname]);

    return (
        <div className="relative border border-black rounded-lg items-center flex gap-2 px-2 py-1 h-fit">
            <Image src="/icons/search.svg" alt="search" width={15} height={15} />
            <input
                placeholder="Search companions..."
                className="outline-none"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
            />
        </div>
    )
}
export default SearchInput

SubjectBreakdown.tsx
'use client';

import { getSubjectColor } from "@/lib/utils";
import Image from "next/image";

interface SubjectBreakdownProps {
    subjectPerformance: Record<string, {
        sessions: number;
        duration: number;
        completion: number;
    }>;
}

const SubjectBreakdown = ({ subjectPerformance }: SubjectBreakdownProps) => {
    const subjects = Object.entries(subjectPerformance).sort((a, b) => b[1].sessions - a[1].sessions);

    if (subjects.length === 0) {
        return null;
    }

    return (
        <section className="rounded-border p-6 bg-white mb-8">
            <h3 className="font-bold text-xl mb-4">Subject Performance</h3>
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                {subjects.map(([subject, data]) => (
                    <div key={subject} className="border border-gray-200 rounded-lg p-4">
                        <div className="flex items-center gap-3 mb-3">
                            <div
                                className="size-12 flex items-center justify-center rounded-lg"
                                style={{ backgroundColor: getSubjectColor(subject) }}
                            >
                                <Image
                                    src={`/icons/${subject}.svg`}
                                    alt={subject}
                                    width={24}
                                    height={24}
                                />
                            </div>
                            <div>
                                <p className="font-semibold capitalize">{subject}</p>
                                <p className="text-sm text-muted-foreground">
                                    {data.sessions} {data.sessions === 1 ? 'session' : 'sessions'}
                                </p>
                            </div>
                        </div>

                        <div className="space-y-2">
                            <div>
                                <div className="flex justify-between text-sm mb-1">
                                    <span className="text-muted-foreground">Completion</span>
                                    <span className="font-medium">{data.completion}%</span>
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-2">
                                    <div
                                        className="bg-primary h-2 rounded-full transition-all"
                                        style={{ width: `${Math.min(data.completion, 100)}%` }}
                                    />
                                </div>
                            </div>

                            <div className="text-sm text-muted-foreground">
                                <span className="font-medium text-foreground">
                                    {Math.round(data.duration / 60)}m
                                </span> total time
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </section>
    );
};

export default SubjectBreakdown;

SubjectFilter.tsx
"use client";
import React, { useEffect, useState } from "react";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "./ui/select";
import { subjects } from "@/constants";
import { useRouter } from "next/navigation";
import { useSearchParams } from "next/navigation";
import { formUrlQuery, removeKeysFromUrlQuery } from "@jsmastery/utils";

const SubjectFilter = () => {
    const router = useRouter();
    const searchParams = useSearchParams();
    const query = searchParams.get("subject") || "";

    const [subject, setSubject] = useState(query);

    useEffect(() => {
        let newUrl = "";
        if (subject === "all") {
            newUrl = removeKeysFromUrlQuery({
                params: searchParams.toString(),
                keysToRemove: ["subject"],
            });
        } else {
            newUrl = formUrlQuery({
                params: searchParams.toString(),
                key: "subject",
                value: subject,
            });
        }
        router.push(newUrl, { scroll: false });
    }, [subject]);

    return (
        <Select onValueChange={setSubject} value={subject}>
            <SelectTrigger className="input capitalize">
                <SelectValue placeholder="Subject" />
            </SelectTrigger>
            <SelectContent>
                <SelectItem value="all">All subjects</SelectItem>
                {subjects.map((subject) => (
                    <SelectItem key={subject} value={subject} className="capitalize">
                        {subject}
                    </SelectItem>
                ))}
            </SelectContent>
        </Select>
    );
};

export default SubjectFilter;

ui
accordion.tsx
"use client"

import * as React from "react"
import * as AccordionPrimitive from "@radix-ui/react-accordion"
import { ChevronDownIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Accordion({
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Root>) {
  return <AccordionPrimitive.Root data-slot="accordion" {...props} />
}

function AccordionItem({
  className,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Item>) {
  return (
    <AccordionPrimitive.Item
      data-slot="accordion-item"
      className={cn("border-b last:border-b-0", className)}
      {...props}
    />
  )
}

function AccordionTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Trigger>) {
  return (
    <AccordionPrimitive.Header className="flex">
      <AccordionPrimitive.Trigger
        data-slot="accordion-trigger"
        className={cn(
          "focus-visible:border-ring focus-visible:ring-ring/50 flex flex-1 items-start justify-between gap-4 rounded-md py-4 text-left text-sm font-medium transition-all outline-none hover:underline focus-visible:ring-[3px] disabled:pointer-events-none disabled:opacity-50 [&[data-state=open]>svg]:rotate-180",
          className
        )}
        {...props}
      >
        {children}
        <ChevronDownIcon className="text-muted-foreground pointer-events-none size-4 shrink-0 translate-y-0.5 transition-transform duration-200" />
      </AccordionPrimitive.Trigger>
    </AccordionPrimitive.Header>
  )
}

function AccordionContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Content>) {
  return (
    <AccordionPrimitive.Content
      data-slot="accordion-content"
      className="data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down overflow-hidden text-sm"
      {...props}
    >
      <div className={cn("pt-0 pb-4", className)}>{children}</div>
    </AccordionPrimitive.Content>
  )
}

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }

button.tsx
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
        "icon-sm": "size-8",
        "icon-lg": "size-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }

card.tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}

chart.tsx
"use client"

import * as React from "react"
import * as RechartsPrimitive from "recharts"

import { cn } from "@/lib/utils"

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode
    icon?: React.ComponentType
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  )
}

type ChartContextProps = {
  config: ChartConfig
}

const ChartContext = React.createContext<ChartContextProps | null>(null)

function useChart() {
  const context = React.useContext(ChartContext)

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />")
  }

  return context
}

function ChartContainer({
  id,
  className,
  children,
  config,
  ...props
}: React.ComponentProps<"div"> & {
  config: ChartConfig
  children: React.ComponentProps<
    typeof RechartsPrimitive.ResponsiveContainer
  >["children"]
}) {
  const uniqueId = React.useId()
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-slot="chart"
        data-chart={chartId}
        className={cn(
          "[&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border flex aspect-video justify-center text-xs [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-hidden [&_.recharts-sector]:outline-hidden [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-surface]:outline-hidden",
          className
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  )
}

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([, config]) => config.theme || config.color
  )

  if (!colorConfig.length) {
    return null
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color =
      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
      itemConfig.color
    return color ? `  --color-${key}: ${color};` : null
  })
  .join("\n")}
}
`
          )
          .join("\n"),
      }}
    />
  )
}

const ChartTooltip = RechartsPrimitive.Tooltip

function ChartTooltipContent({
  active,
  payload,
  className,
  indicator = "dot",
  hideLabel = false,
  hideIndicator = false,
  label,
  labelFormatter,
  labelClassName,
  formatter,
  color,
  nameKey,
  labelKey,
}: React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
  React.ComponentProps<"div"> & {
    hideLabel?: boolean
    hideIndicator?: boolean
    indicator?: "line" | "dot" | "dashed"
    nameKey?: string
    labelKey?: string
  }) {
  const { config } = useChart()

  const tooltipLabel = React.useMemo(() => {
    if (hideLabel || !payload?.length) {
      return null
    }

    const [item] = payload
    const key = `${labelKey || item?.dataKey || item?.name || "value"}`
    const itemConfig = getPayloadConfigFromPayload(config, item, key)
    const value =
      !labelKey && typeof label === "string"
        ? config[label as keyof typeof config]?.label || label
        : itemConfig?.label

    if (labelFormatter) {
      return (
        <div className={cn("font-medium", labelClassName)}>
          {labelFormatter(value, payload)}
        </div>
      )
    }

    if (!value) {
      return null
    }

    return <div className={cn("font-medium", labelClassName)}>{value}</div>
  }, [
    label,
    labelFormatter,
    payload,
    hideLabel,
    labelClassName,
    config,
    labelKey,
  ])

  if (!active || !payload?.length) {
    return null
  }

  const nestLabel = payload.length === 1 && indicator !== "dot"

  return (
    <div
      className={cn(
        "border-border/50 bg-background grid min-w-[8rem] items-start gap-1.5 rounded-lg border px-2.5 py-1.5 text-xs shadow-xl",
        className
      )}
    >
      {!nestLabel ? tooltipLabel : null}
      <div className="grid gap-1.5">
        {payload
          .filter((item) => item.type !== "none")
          .map((item, index) => {
            const key = `${nameKey || item.name || item.dataKey || "value"}`
            const itemConfig = getPayloadConfigFromPayload(config, item, key)
            const indicatorColor = color || item.payload.fill || item.color

            return (
              <div
                key={item.dataKey}
                className={cn(
                  "[&>svg]:text-muted-foreground flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5",
                  indicator === "dot" && "items-center"
                )}
              >
                {formatter && item?.value !== undefined && item.name ? (
                  formatter(item.value, item.name, item, index, item.payload)
                ) : (
                  <>
                    {itemConfig?.icon ? (
                      <itemConfig.icon />
                    ) : (
                      !hideIndicator && (
                        <div
                          className={cn(
                            "shrink-0 rounded-[2px] border-(--color-border) bg-(--color-bg)",
                            {
                              "h-2.5 w-2.5": indicator === "dot",
                              "w-1": indicator === "line",
                              "w-0 border-[1.5px] border-dashed bg-transparent":
                                indicator === "dashed",
                              "my-0.5": nestLabel && indicator === "dashed",
                            }
                          )}
                          style={
                            {
                              "--color-bg": indicatorColor,
                              "--color-border": indicatorColor,
                            } as React.CSSProperties
                          }
                        />
                      )
                    )}
                    <div
                      className={cn(
                        "flex flex-1 justify-between leading-none",
                        nestLabel ? "items-end" : "items-center"
                      )}
                    >
                      <div className="grid gap-1.5">
                        {nestLabel ? tooltipLabel : null}
                        <span className="text-muted-foreground">
                          {itemConfig?.label || item.name}
                        </span>
                      </div>
                      {item.value && (
                        <span className="text-foreground font-mono font-medium tabular-nums">
                          {item.value.toLocaleString()}
                        </span>
                      )}
                    </div>
                  </>
                )}
              </div>
            )
          })}
      </div>
    </div>
  )
}

const ChartLegend = RechartsPrimitive.Legend

function ChartLegendContent({
  className,
  hideIcon = false,
  payload,
  verticalAlign = "bottom",
  nameKey,
}: React.ComponentProps<"div"> &
  Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
    hideIcon?: boolean
    nameKey?: string
  }) {
  const { config } = useChart()

  if (!payload?.length) {
    return null
  }

  return (
    <div
      className={cn(
        "flex items-center justify-center gap-4",
        verticalAlign === "top" ? "pb-3" : "pt-3",
        className
      )}
    >
      {payload
        .filter((item) => item.type !== "none")
        .map((item) => {
          const key = `${nameKey || item.dataKey || "value"}`
          const itemConfig = getPayloadConfigFromPayload(config, item, key)

          return (
            <div
              key={item.value}
              className={cn(
                "[&>svg]:text-muted-foreground flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3"
              )}
            >
              {itemConfig?.icon && !hideIcon ? (
                <itemConfig.icon />
              ) : (
                <div
                  className="h-2 w-2 shrink-0 rounded-[2px]"
                  style={{
                    backgroundColor: item.color,
                  }}
                />
              )}
              {itemConfig?.label}
            </div>
          )
        })}
    </div>
  )
}

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string
) {
  if (typeof payload !== "object" || payload === null) {
    return undefined
  }

  const payloadPayload =
    "payload" in payload &&
    typeof payload.payload === "object" &&
    payload.payload !== null
      ? payload.payload
      : undefined

  let configLabelKey: string = key

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === "string"
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config]
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
}

form.tsx
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { Slot } from "@radix-ui/react-slot"
import {
  Controller,
  FormProvider,
  useFormContext,
  useFormState,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from "react-hook-form"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"

const Form = FormProvider

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
> = {
  name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue
)

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  )
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState } = useFormContext()
  const formState = useFormState({ name: fieldContext.name })
  const fieldState = getFieldState(fieldContext.name, formState)

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>")
  }

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

type FormItemContextValue = {
  id: string
}

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue
)

function FormItem({ className, ...props }: React.ComponentProps<"div">) {
  const id = React.useId()

  return (
    <FormItemContext.Provider value={{ id }}>
      <div
        data-slot="form-item"
        className={cn("grid gap-2", className)}
        {...props}
      />
    </FormItemContext.Provider>
  )
}

function FormLabel({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  const { error, formItemId } = useFormField()

  return (
    <Label
      data-slot="form-label"
      data-error={!!error}
      className={cn("data-[error=true]:text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  )
}

function FormControl({ ...props }: React.ComponentProps<typeof Slot>) {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    <Slot
      data-slot="form-control"
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  )
}

function FormDescription({ className, ...props }: React.ComponentProps<"p">) {
  const { formDescriptionId } = useFormField()

  return (
    <p
      data-slot="form-description"
      id={formDescriptionId}
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function FormMessage({ className, ...props }: React.ComponentProps<"p">) {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message ?? "") : props.children

  if (!body) {
    return null
  }

  return (
    <p
      data-slot="form-message"
      id={formMessageId}
      className={cn("text-destructive text-sm", className)}
      {...props}
    >
      {body}
    </p>
  )
}

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}

input.tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }

label.tsx
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }

select.tsx
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { CheckIcon, ChevronDownIcon, ChevronUpIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  size = "default",
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {
  size?: "sm" | "default"
}) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      data-size={size}
      className={cn(
        "border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  align = "center",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        position={position}
        align={align}
        {...props}
      >
        <SelectScrollUpButton />
        <SelectPrimitive.Viewport
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
        <SelectScrollDownButton />
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("text-muted-foreground px-2 py-1.5 text-xs", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
        className
      )}
      {...props}
    >
      <span className="absolute right-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-border pointer-events-none -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function SelectScrollUpButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
  return (
    <SelectPrimitive.ScrollUpButton
      data-slot="select-scroll-up-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronUpIcon className="size-4" />
    </SelectPrimitive.ScrollUpButton>
  )
}

function SelectScrollDownButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
  return (
    <SelectPrimitive.ScrollDownButton
      data-slot="select-scroll-down-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronDownIcon className="size-4" />
    </SelectPrimitive.ScrollDownButton>
  )
}

export {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectScrollDownButton,
  SelectScrollUpButton,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
}

switch.tsx
"use client"

import * as React from "react"
import * as SwitchPrimitive from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

function Switch({
  className,
  ...props
}: React.ComponentProps<typeof SwitchPrimitive.Root>) {
  return (
    <SwitchPrimitive.Root
      data-slot="switch"
      className={cn(
        "peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent shadow-xs transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <SwitchPrimitive.Thumb
        data-slot="switch-thumb"
        className={cn(
          "bg-background dark:data-[state=unchecked]:bg-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0"
        )}
      />
    </SwitchPrimitive.Root>
  )
}

export { Switch }

table.tsx
"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}

textarea.tsx
import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }

constants
index.ts
export const subjects = [
  "maths",
  "language",
  "science",
  "history",
  "coding",
  "economics",
];

export const subjectsColors = {
  science: "#E5D0FF",
  maths: "#FFDA6E",
  language: "#BDE7FF",
  coding: "#FFC8E4",
  history: "#FFECC8",
  economics: "#C8FFDF",
};

export const voices = {
  male: { casual: "2BJW5coyhAzSr8STdHbE", formal: "c6SfcYrb2t09NHXiT80T" },
  female: { casual: "ZIlrSGI4jZqobxRKprJz", formal: "sarah" },
};

export const recentSessions = [
  {
    id: "1",
    subject: "science",
    name: "Neura the Brainy Explorer",
    topic: "Neural Network of the Brain",
    duration: 45,
    color: "#E5D0FF",
  },
  {
    id: "2",
    subject: "maths",
    name: "Countsy the Number Wizard",
    topic: "Derivatives & Integrals",
    duration: 30,
    color: "#FFDA6E",
  },
  {
    id: "3",
    subject: "language",
    name: "Verba the Vocabulary Builder",
    topic: "English Literature",
    duration: 30,
    color: "#BDE7FF",
  },
  {
    id: "4",
    subject: "coding",
    name: "Codey the Logic Hacker",
    topic: "Intro to If-Else Statements",
    duration: 45,
    color: "#FFC8E4",
  },
  {
    id: "5",
    subject: "history",
    name: "Memo, the Memory Keeper",
    topic: "World Wars: Causes & Consequences",
    duration: 15,
    color: "#FFECC8",
  },
  {
    id: "6",
    subject: "economics",
    name: "The Market Maestro",
    topic: "The Basics of Supply & Demand",
    duration: 10,
    color: "#C8FFDF",
  },
];

{}soundwaves.json
{"nm":"Render","ddd":0,"h":250,"w":250,"meta":{"g":"LottieFiles AE 3.1.1"},"layers":[{"ty":4,"nm":"Arrow Outlines 4","sr":1,"st":0,"op":300.00001221925,"ip":0,"hd":false,"ddd":0,"bm":0,"hasMask":false,"ao":0,"ks":{"a":{"a":0,"k":[13,15.5,0],"ix":1},"s":{"a":0,"k":[170,170,100],"ix":6},"sk":{"a":0,"k":0},"p":{"a":0,"k":[100.5,126,0],"ix":2},"r":{"a":0,"k":0,"ix":10},"sa":{"a":0,"k":0},"o":{"a":0,"k":100,"ix":11}},"ef":[],"shapes":[{"ty":"sh","bm":0,"hd":false,"mn":"ADBE Vector Shape - Group","nm":"Path 1","ix":1,"d":1,"ks":{"a":1,"k":[{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.471,13.618],[12.471,14.676]]}],"t":0},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.471,8.103],[12.471,18.868]]}],"t":30},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.471,8.324],[12.471,19.235]]}],"t":45},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.515,4.206],[12.515,25.853]]}],"t":70},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.471,8.985],[12.471,17.912]]}],"t":83},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.515,5.309],[12.544,24.088]]}],"t":97},{"o":{"x":0.333,"y":0},"i":{"x":1,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.456,7.588],[12.456,20.044]]}],"t":109},{"o":{"x":0.333,"y":0},"i":{"x":1,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.456,6.265],[12.456,21]]}],"t":121},{"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.471,13.618],[12.471,14.676]]}],"t":128.000005213547}],"ix":2}},{"ty":"st","bm":0,"hd":false,"mn":"ADBE Vector Graphic - Stroke","nm":"Stroke 1","lc":2,"lj":1,"ml":4,"o":{"a":0,"k":100,"ix":4},"w":{"a":0,"k":4,"ix":5},"c":{"a":0,"k":[0.9922,0.949,0.9922,1],"ix":3}},{"ty":"sh","bm":0,"hd":false,"mn":"ADBE Vector Shape - Group","nm":"Path 2","ix":3,"d":1,"ks":{"a":0,"k":{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.441,11.118],[12.441,16.735]]},"ix":2}}],"ind":1},{"ty":4,"nm":"Arrow Outlines 3","sr":1,"st":0,"op":300.00001221925,"ip":0,"hd":false,"ddd":0,"bm":0,"hasMask":false,"ao":0,"ks":{"a":{"a":0,"k":[13,15.5,0],"ix":1},"s":{"a":0,"k":[170,170,100],"ix":6},"sk":{"a":0,"k":0},"p":{"a":0,"k":[146.75,126,0],"ix":2},"r":{"a":0,"k":0,"ix":10},"sa":{"a":0,"k":0},"o":{"a":0,"k":100,"ix":11}},"ef":[],"shapes":[{"ty":"sh","bm":0,"hd":false,"mn":"ADBE Vector Shape - Group","nm":"Path 1","ix":1,"d":1,"ks":{"a":1,"k":[{"o":{"x":0.973,"y":0},"i":{"x":0.581,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.471,13.618],[12.471,14.676]]}],"t":0},{"o":{"x":0.973,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.441,13.765],[12.441,18.353]]}],"t":30},{"o":{"x":0.973,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.471,13.618],[12.471,13.721]]}],"t":45},{"o":{"x":0.167,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.529,7.074],[12.5,15.191]]}],"t":70},{"o":{"x":0.973,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.456,5.529],[12.441,16.735]]}],"t":83},{"o":{"x":0.167,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.544,7.147],[12.515,15.044]]}],"t":97},{"o":{"x":0.973,"y":0},"i":{"x":0.592,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.456,3.103],[12.471,21.809]]}],"t":109},{"o":{"x":0.973,"y":0},"i":{"x":0.893,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.441,11.118],[12.441,16.735]]}],"t":122},{"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.471,13.618],[12.471,14.676]]}],"t":129.000005254278}],"ix":2}},{"ty":"st","bm":0,"hd":false,"mn":"ADBE Vector Graphic - Stroke","nm":"Stroke 1","lc":2,"lj":1,"ml":4,"o":{"a":0,"k":100,"ix":4},"w":{"a":0,"k":4,"ix":5},"c":{"a":0,"k":[0.9922,0.949,0.9922,1],"ix":3}},{"ty":"sh","bm":0,"hd":false,"mn":"ADBE Vector Shape - Group","nm":"Path 2","ix":3,"d":1,"ks":{"a":0,"k":{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.441,11.118],[12.441,16.735]]},"ix":2}}],"ind":2},{"ty":4,"nm":"Arrow Outlines 2","sr":1,"st":0,"op":300.00001221925,"ip":0,"hd":false,"ddd":0,"bm":0,"hasMask":false,"ao":0,"ks":{"a":{"a":0,"k":[13,15.5,0],"ix":1},"s":{"a":0,"k":[170,170,100],"ix":6},"sk":{"a":0,"k":0},"p":{"a":0,"k":[116.75,126,0],"ix":2},"r":{"a":0,"k":0,"ix":10},"sa":{"a":0,"k":0},"o":{"a":0,"k":100,"ix":11}},"ef":[],"shapes":[{"ty":"sh","bm":0,"hd":false,"mn":"ADBE Vector Shape - Group","nm":"Path 1","ix":1,"d":1,"ks":{"a":1,"k":[{"o":{"x":0.333,"y":0},"i":{"x":0,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.471,13.618],[12.471,14.676]]}],"t":0},{"o":{"x":0.333,"y":0},"i":{"x":0,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.441,11.118],[12.441,16.735]]}],"t":24},{"o":{"x":0.973,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.441,4.647],[12.441,25.706]]}],"t":41},{"o":{"x":0.973,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.441,11.118],[12.441,16.735]]}],"t":55},{"o":{"x":0.167,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.471,6.118],[12.471,20.412]]}],"t":70},{"o":{"x":0.973,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.456,1.926],[12.456,22.838]]}],"t":87},{"o":{"x":0.973,"y":0},"i":{"x":0,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.471,7.735],[12.471,20.265]]}],"t":101},{"o":{"x":0.333,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.441,11.118],[12.441,16.735]]}],"t":115},{"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.471,13.618],[12.471,14.676]]}],"t":134.000005457932}],"ix":2}},{"ty":"st","bm":0,"hd":false,"mn":"ADBE Vector Graphic - Stroke","nm":"Stroke 1","lc":2,"lj":1,"ml":4,"o":{"a":0,"k":100,"ix":4},"w":{"a":0,"k":4,"ix":5},"c":{"a":0,"k":[0.9922,0.949,0.9922,1],"ix":3}},{"ty":"sh","bm":0,"hd":false,"mn":"ADBE Vector Shape - Group","nm":"Path 2","ix":3,"d":1,"ks":{"a":0,"k":{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.441,11.118],[12.441,16.735]]},"ix":2}}],"ind":3},{"ty":4,"nm":"Arrow Outlines","sr":1,"st":0,"op":300.00001221925,"ip":0,"hd":false,"ddd":0,"bm":0,"hasMask":false,"ao":0,"ks":{"a":{"a":0,"k":[13,15.5,0],"ix":1},"s":{"a":0,"k":[170,170,100],"ix":6},"sk":{"a":0,"k":0},"p":{"a":0,"k":[131.75,126,0],"ix":2},"r":{"a":0,"k":0,"ix":10},"sa":{"a":0,"k":0},"o":{"a":0,"k":100,"ix":11}},"ef":[],"shapes":[{"ty":"sh","bm":0,"hd":false,"mn":"ADBE Vector Shape - Group","nm":"Path 1","ix":1,"d":1,"ks":{"a":1,"k":[{"o":{"x":0.973,"y":0},"i":{"x":0.581,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.471,13.618],[12.471,14.676]]}],"t":0},{"o":{"x":0.973,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.5,2],[12.5,28.5]]}],"t":30},{"o":{"x":0.973,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.441,11.118],[12.441,16.735]]}],"t":45},{"o":{"x":0.167,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.5,2],[12.5,28.5]]}],"t":70},{"o":{"x":0.973,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.441,11.118],[12.441,16.735]]}],"t":83},{"o":{"x":0.167,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.5,2],[12.5,28.5]]}],"t":97},{"o":{"x":0.973,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.471,5.75],[12.471,21.809]]}],"t":109},{"o":{"x":0.973,"y":0},"i":{"x":0.24,"y":1},"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.441,11.118],[12.441,16.735]]}],"t":125},{"s":[{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.471,13.618],[12.471,14.676]]}],"t":132.00000537647}],"ix":2}},{"ty":"st","bm":0,"hd":false,"mn":"ADBE Vector Graphic - Stroke","nm":"Stroke 1","lc":2,"lj":1,"ml":4,"o":{"a":0,"k":100,"ix":4},"w":{"a":0,"k":4,"ix":5},"c":{"a":0,"k":[0.9922,0.949,0.9922,1],"ix":3}},{"ty":"sh","bm":0,"hd":false,"mn":"ADBE Vector Shape - Group","nm":"Path 2","ix":3,"d":1,"ks":{"a":0,"k":{"c":false,"i":[[0,0],[0,0]],"o":[[0,0],[0,0]],"v":[[12.441,11.118],[12.441,16.735]]},"ix":2}}],"ind":4},{"ty":4,"nm":"cir 1","sr":1,"st":0,"op":300.00001221925,"ip":0,"hd":false,"ddd":0,"bm":0,"hasMask":false,"ao":0,"ks":{"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":1,"k":[{"o":{"x":0.775,"y":0},"i":{"x":0.206,"y":1},"s":[111.8,111.8,100],"t":0},{"o":{"x":0.665,"y":0},"i":{"x":0.274,"y":1},"s":[120,120,100],"t":30},{"o":{"x":0.167,"y":0},"i":{"x":0.206,"y":1},"s":[111.8,111.8,100],"t":60},{"o":{"x":0.665,"y":0},"i":{"x":0.274,"y":1},"s":[120,120,100],"t":71.289},{"o":{"x":0.167,"y":0},"i":{"x":0.206,"y":1},"s":[111.8,111.8,100],"t":82.576},{"o":{"x":0.665,"y":0},"i":{"x":0.274,"y":1},"s":[120,120,100],"t":97.628},{"o":{"x":0.167,"y":0},"i":{"x":0.667,"y":1},"s":[111.8,111.8,100],"t":107.661},{"s":[111.8,111.8,100],"t":134.000005457932}],"ix":6},"sk":{"a":0,"k":0},"p":{"a":0,"k":[126.539,126.166,0],"ix":2},"r":{"a":0,"k":0,"ix":10},"sa":{"a":0,"k":0},"o":{"a":0,"k":100,"ix":11}},"ef":[],"shapes":[{"ty":"gr","bm":0,"hd":false,"mn":"ADBE Vector Group","nm":"Ellipse 1","ix":1,"cix":2,"np":3,"it":[{"ty":"el","bm":0,"hd":false,"mn":"ADBE Vector Shape - Ellipse","nm":"Ellipse Path 1","d":1,"p":{"a":0,"k":[0,0],"ix":3},"s":{"a":0,"k":[99.367,99.367],"ix":2}},{"ty":"fl","bm":0,"hd":false,"mn":"ADBE Vector Graphic - Fill","nm":"Fill 1","c":{"a":0,"k":[0.1255,0.1529,0.1725,1],"ix":4},"r":1,"o":{"a":0,"k":100,"ix":5}},{"ty":"tr","a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"sk":{"a":0,"k":0,"ix":4},"p":{"a":0,"k":[-1.539,-1.166],"ix":2},"r":{"a":0,"k":0,"ix":6},"sa":{"a":0,"k":0,"ix":5},"o":{"a":0,"k":100,"ix":7}}]}],"ind":5},{"ty":4,"nm":"cir 2","sr":1,"st":0,"op":300.00001221925,"ip":0,"hd":false,"ddd":0,"bm":0,"hasMask":false,"ao":0,"ks":{"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":1,"k":[{"o":{"x":0.775,"y":0},"i":{"x":0.206,"y":1},"s":[110,110,100],"t":0},{"o":{"x":0.665,"y":0},"i":{"x":0.274,"y":1},"s":[194.775,194.775,100],"t":34},{"o":{"x":0.167,"y":0},"i":{"x":0.206,"y":1},"s":[150,150,100],"t":60},{"o":{"x":0.665,"y":0},"i":{"x":0.274,"y":1},"s":[194.775,194.775,100],"t":71.289},{"o":{"x":0.167,"y":0},"i":{"x":0.206,"y":1},"s":[150,150,100],"t":82.576},{"o":{"x":0.665,"y":0},"i":{"x":0.274,"y":1},"s":[194.775,194.775,100],"t":97.628},{"o":{"x":0.167,"y":0},"i":{"x":0.274,"y":1},"s":[150,150,100],"t":117},{"s":[110,110,100],"t":123.966255049249}],"ix":6},"sk":{"a":0,"k":0},"p":{"a":0,"k":[126.539,126.166,0],"ix":2},"r":{"a":0,"k":0,"ix":10},"sa":{"a":0,"k":0},"o":{"a":0,"k":100,"ix":11}},"ef":[],"shapes":[{"ty":"gr","bm":0,"hd":false,"mn":"ADBE Vector Group","nm":"Ellipse 1","ix":1,"cix":2,"np":3,"it":[{"ty":"el","bm":0,"hd":false,"mn":"ADBE Vector Shape - Ellipse","nm":"Ellipse Path 1","d":1,"p":{"a":0,"k":[0,0],"ix":3},"s":{"a":0,"k":[99.367,99.367],"ix":2}},{"ty":"fl","bm":0,"hd":false,"mn":"ADBE Vector Graphic - Fill","nm":"Fill 1","c":{"a":0,"k":[0.1255,0.1529,0.1725,1],"ix":4},"r":1,"o":{"a":0,"k":10,"ix":5}},{"ty":"tr","a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"sk":{"a":0,"k":0,"ix":4},"p":{"a":0,"k":[-1.539,-1.166],"ix":2},"r":{"a":0,"k":0,"ix":6},"sa":{"a":0,"k":0,"ix":5},"o":{"a":0,"k":100,"ix":7}}]}],"ind":6},{"ty":4,"nm":"cir 3","sr":1,"st":0,"op":300.00001221925,"ip":0,"hd":false,"ddd":0,"bm":0,"hasMask":false,"ao":0,"ks":{"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":1,"k":[{"o":{"x":0.775,"y":0},"i":{"x":0.206,"y":1},"s":[110,110,100],"t":0},{"o":{"x":0.665,"y":0},"i":{"x":0.274,"y":1},"s":[230,230,100],"t":34},{"o":{"x":0.167,"y":0},"i":{"x":0.206,"y":1},"s":[190,190,100],"t":60},{"o":{"x":0.665,"y":0},"i":{"x":0.274,"y":1},"s":[230,230,100],"t":71.289},{"o":{"x":0.167,"y":0},"i":{"x":0.206,"y":1},"s":[190,190,100],"t":82.576},{"o":{"x":0.665,"y":0},"i":{"x":0.274,"y":1},"s":[230,230,100],"t":97.628},{"o":{"x":0.167,"y":0},"i":{"x":0.274,"y":1},"s":[190,190,100],"t":118},{"s":[110,110,100],"t":134.000005457932}],"ix":6},"sk":{"a":0,"k":0},"p":{"a":0,"k":[126.539,126.166,0],"ix":2},"r":{"a":0,"k":0,"ix":10},"sa":{"a":0,"k":0},"o":{"a":0,"k":100,"ix":11}},"ef":[],"shapes":[{"ty":"gr","bm":0,"hd":false,"mn":"ADBE Vector Group","nm":"Ellipse 1","ix":1,"cix":2,"np":3,"it":[{"ty":"el","bm":0,"hd":false,"mn":"ADBE Vector Shape - Ellipse","nm":"Ellipse Path 1","d":1,"p":{"a":0,"k":[0,0],"ix":3},"s":{"a":0,"k":[99.367,99.367],"ix":2}},{"ty":"fl","bm":0,"hd":false,"mn":"ADBE Vector Graphic - Fill","nm":"Fill 1","c":{"a":0,"k":[0.1255,0.1529,0.1725,1],"ix":4},"r":1,"o":{"a":0,"k":5,"ix":5}},{"ty":"tr","a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"sk":{"a":0,"k":0,"ix":4},"p":{"a":0,"k":[-1.539,-1.166],"ix":2},"r":{"a":0,"k":0,"ix":6},"sa":{"a":0,"k":0,"ix":5},"o":{"a":0,"k":100,"ix":7}}]}],"ind":7}],"v":"4.8.0","fr":29.9700012207031,"op":135.000005498663,"ip":0,"assets":[]}

lib
supabase.ts
import {createClient} from "@supabase/supabase-js";
import {auth} from "@clerk/nextjs/server";

export const createSupabaseClient = () => {
    return createClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {
            async accessToken() {
                return ((await auth()).getToken());
            }
        }
    )
}

utils.ts
import { clsx, type ClassValue } from "clsx";
import { twMerge } from "tailwind-merge";
import { subjectsColors, voices } from "@/constants";
import { CreateAssistantDTO } from "@vapi-ai/web/dist/api";

export function cn(...inputs: ClassValue[]) {
    return twMerge(clsx(inputs));
}

export const getSubjectColor = (subject: string) => {
    return subjectsColors[subject as keyof typeof subjectsColors];
};

export const configureAssistant = (voice: string, style: string) => {
    const voiceId = voices[voice as keyof typeof voices][
        style as keyof (typeof voices)[keyof typeof voices]
        ] || "sarah";

    const vapiAssistant: CreateAssistantDTO = {
        name: "Companion",
        firstMessage:
            "Hello, let's start the session. Today we'll be talking about {{topic}}.",
        transcriber: {
            provider: "deepgram",
            model: "nova-3",
            language: "en",
        },
        voice: {
            provider: "11labs",
            voiceId: voiceId,
            stability: 0.4,
            similarityBoost: 0.8,
            speed: 1,
            style: 0.5,
            useSpeakerBoost: true,
        },
        model: {
            provider: "openai",
            model: "gpt-4",
            messages: [
                {
                    role: "system",
                    content: `You are a highly knowledgeable tutor teaching a real-time voice session with a student. Your goal is to teach the student about the topic and subject.

                    Tutor Guidelines:
                    Stick to the given topic - {{ topic }} and subject - {{ subject }} and teach the student about it.
                    Keep the conversation flowing smoothly while maintaining control.
                    From time to time make sure that the student is following you and understands you.
                    Break down the topic into smaller parts and teach the student one part at a time.
                    Keep your style of conversation {{ style }}.
                    Keep your responses short, like in a real voice conversation.
                    Do not include any special characters in your responses - this is a voice conversation.
              `,
                },
            ],
        },
        clientMessages: [],
        serverMessages: [],
    };
    return vapiAssistant;
};

vapi.sdk.ts
import Vapi from "@vapi-ai/web";

export const vapi = new Vapi(process.env.NEXT_PUBLIC_VAPI_WEB_TOKEN!);

actions
companion.actions.ts
'use server';

import {auth} from "@clerk/nextjs/server";
import {createSupabaseClient} from "@/lib/supabase";
import { revalidatePath } from "next/cache";

// ==================== COMPANION CRUD ====================

export const createCompanion = async (formData: CreateCompanion) => {
    const { userId: author } = await auth();
    const supabase = createSupabaseClient();

    const { data, error } = await supabase
        .from('companions')
        .insert({...formData, author })
        .select();

    if(error || !data) throw new Error(error?.message || 'Failed to create a companion');

    return data[0];
}

export const getAllCompanions = async ({ limit = 10, page = 1, subject, topic }: GetAllCompanions) => {
    const supabase = createSupabaseClient();

    let query = supabase.from('companions').select();

    if(subject && topic) {
        query = query.ilike('subject', `%${subject}%`)
            .or(`topic.ilike.%${topic}%,name.ilike.%${topic}%`)
    } else if(subject) {
        query = query.ilike('subject', `%${subject}%`)
    } else if(topic) {
        query = query.or(`topic.ilike.%${topic}%,name.ilike.%${topic}%`)
    }

    query = query.range((page - 1) * limit, page * limit - 1);

    const { data: companions, error } = await query;

    if(error) {
        console.error('âŒ getAllCompanions error:', error);
        throw new Error(`Failed to fetch companions: ${error.message || JSON.stringify(error)}`);
    }

    return companions;
}

export const getCompanion = async (id: string) => {
    const supabase = createSupabaseClient();

    const { data, error } = await supabase
        .from('companions')
        .select()
        .eq('id', id);

    if(error) return console.log(error);

    return data[0];
}

export const getUserCompanions = async (userId: string) => {
    const supabase = createSupabaseClient();
    const { data, error } = await supabase
        .from('companions')
        .select()
        .eq('author', userId)

    if(error) throw new Error(error.message);

    return data;
}

export const newCompanionPermissions = async () => {
    const { userId, has } = await auth();
    const supabase = createSupabaseClient();

    let limit = 3; // âœ… Default limit for free users

    if(has({ plan: 'pro' })) {
        return true; // Unlimited for pro users
    } else if(has({ feature: "3_companion_limit" })) {
        limit = 3;
    } else if(has({ feature: "10_companion_limit" })) {
        limit = 10;
    }

    const { data, error } = await supabase
        .from('companions')
        .select('id', { count: 'exact' })
        .eq('author', userId)

    if(error) throw new Error(error.message);

    const companionCount = data?.length || 0;

    return companionCount < limit;
}

// ==================== SESSION HISTORY ====================

export const addToSessionHistory = async (companionId: string, duration?: number) => {
    const { userId } = await auth();
    const supabase = createSupabaseClient();

    const insertData: any = {
        companion_id: companionId,
        user_id: userId,
    };

    // Add duration if provided
    if (duration !== undefined) {
        insertData.duration = duration;
    }

    const { data, error } = await supabase
        .from('session_history')
        .insert(insertData)
        .select();

    if(error) throw new Error(error.message);

    return data;
}

export const getRecentSessions = async (limit = 10) => {
    const supabase = createSupabaseClient();
    const { data, error } = await supabase
        .from('session_history')
        .select(`companions:companion_id (*)`)
        .order('created_at', { ascending: false })
        .limit(limit * 3)

    if(error) throw new Error(error.message);

    // âœ… Deduplicate companions by ID
    const companionsMap = new Map();
    data.forEach(({ companions }) => {
        if (companions && !companionsMap.has(companions.id)) {
            companionsMap.set(companions.id, companions);
        }
    });

    return Array.from(companionsMap.values()).slice(0, limit);
}

export const getUserSessions = async (userId: string, limit = 10) => {
    const supabase = createSupabaseClient();
    const { data, error } = await supabase
        .from('session_history')
        .select(`companions:companion_id (*)`)
        .eq('user_id', userId)
        .order('created_at', { ascending: false })
        .limit(limit * 3)

    if(error) throw new Error(error.message);

    // âœ… Deduplicate companions by ID
    const companionsMap = new Map();
    data.forEach(({ companions }) => {
        if (companions && !companionsMap.has(companions.id)) {
            companionsMap.set(companions.id, companions);
        }
    });

    return Array.from(companionsMap.values()).slice(0, limit);
}

// ==================== BOOKMARKS ====================

export const addBookmark = async (companionId: string, path: string) => {
    const { userId } = await auth();
    if (!userId) return;
    const supabase = createSupabaseClient();
    const { data, error } = await supabase.from("bookmarks").insert({
        companion_id: companionId,
        user_id: userId,
    });
    if (error) {
        throw new Error(error.message);
    }
    revalidatePath(path);
    return data;
};

export const removeBookmark = async (companionId: string, path: string) => {
    const { userId } = await auth();
    if (!userId) return;
    const supabase = createSupabaseClient();
    const { data, error } = await supabase
        .from("bookmarks")
        .delete()
        .eq("companion_id", companionId)
        .eq("user_id", userId);
    if (error) {
        throw new Error(error.message);
    }
    revalidatePath(path);
    return data;
};

export const getBookmarkedCompanions = async (userId: string) => {
    const supabase = createSupabaseClient();
    const { data, error } = await supabase
        .from("bookmarks")
        .select(`companions:companion_id (*)`)
        .eq("user_id", userId);
    if (error) {
        throw new Error(error.message);
    }
    return data.map(({ companions }) => companions);
};

// ==================== CONVERSATION HISTORY (NEW) ====================

// Check if user has access to conversation history features
// Free (3_companion_limit) = No access
// Core (10_companion_limit) = Has access
// Pro (unlimited/pro plan) = Has access
export const hasConversationHistoryAccess = async () => {
    const { has } = await auth();

    // Pro users (unlimited companions) have access
    if (has({ plan: 'pro' })) return true;

    // Core users (10 companion limit) have access
    if (has({ feature: "10_companion_limit" })) return true;

    // Free users (3 companion limit) don't have access
    return false;
};

export const saveConversationHistory = async ({
                                                  sessionId,
                                                  companionId,
                                                  messages,
                                                  duration,
                                              }: {
    sessionId: string;
    companionId: string;
    messages: SavedMessage[];
    duration?: number;
}) => {
    const { userId } = await auth();
    if (!userId) {
        console.error('âŒ No userId found when saving conversation');
        throw new Error('User not authenticated');
    }

    // âœ… Check if user has access to conversation history
    const hasAccess = await hasConversationHistoryAccess();
    if (!hasAccess) {
        console.log('â„¹ï¸ User does not have access to conversation history (Basic plan)');
        return null; // Don't save for basic plan users
    }

    console.log('ðŸ’¾ Attempting to save conversation:', {
        sessionId,
        companionId,
        userId,
        messageCount: messages.length,
        duration,
    });

    const supabase = createSupabaseClient();

    const { data, error } = await supabase
        .from('conversation_history')
        .insert({
            session_id: sessionId,
            companion_id: companionId,
            user_id: userId,
            messages: messages,
            duration: duration,
        })
        .select()
        .single();

    if (error) {
        console.error('âŒ Error saving conversation:', error);
        console.error('Error details:', JSON.stringify(error, null, 2));
        throw new Error(`Failed to save conversation: ${error.message}`);
    }

    console.log('âœ… Conversation saved successfully:', data);
    return data;
};

export const getUserConversations = async (limit = 20, page = 1, sortOrder: 'asc' | 'desc' = 'asc') => {
    const { userId } = await auth();
    if (!userId) throw new Error('User not authenticated');

    // âœ… Check access
    const hasAccess = await hasConversationHistoryAccess();
    if (!hasAccess) {
        return []; // Return empty array for basic plan users
    }

    const supabase = createSupabaseClient();

    const { data, error } = await supabase
        .from('conversation_history')
        .select(`
            *,
            companions:companion_id (id, name, subject, topic, duration),
            session_history:session_id (created_at)
        `)
        .eq('user_id', userId)
        .order('created_at', { ascending: sortOrder === 'asc' }) // âœ… Configurable sort order
        .range((page - 1) * limit, page * limit - 1);

    if (error) throw new Error(error.message);

    console.log('ðŸ“Š getUserConversations:', {
        count: data.length,
        sortOrder,
        ascending: sortOrder === 'asc',
        firstConversation: data[0] ? {
            id: data[0].id.substring(0, 8),
            created_at: data[0].created_at,
        } : null,
        lastConversation: data[data.length - 1] ? {
            id: data[data.length - 1].id.substring(0, 8),
            created_at: data[data.length - 1].created_at,
        } : null,
        allDates: data.map(d => d.created_at),
    });

    return data;
};

export const getCompanionConversations = async (companionId: string, limit = 10) => {
    const { userId } = await auth();
    if (!userId) throw new Error('User not authenticated');

    // âœ… Check access
    const hasAccess = await hasConversationHistoryAccess();
    if (!hasAccess) {
        return [];
    }

    const supabase = createSupabaseClient();

    const { data, error } = await supabase
        .from('conversation_history')
        .select(`
            *,
            companions:companion_id (id, name, subject, topic)
        `)
        .eq('user_id', userId)
        .eq('companion_id', companionId)
        .order('created_at', { ascending: false }) // âœ… Descending order (newest first from DB)
        .limit(limit);

    if (error) throw new Error(error.message);

    return data;
};

export const getConversationById = async (conversationId: string) => {
    const { userId } = await auth();
    if (!userId) throw new Error('User not authenticated');

    // âœ… Check access
    const hasAccess = await hasConversationHistoryAccess();
    if (!hasAccess) {
        throw new Error('Access denied: Upgrade to Core or Pro plan');
    }

    const supabase = createSupabaseClient();

    const { data, error } = await supabase
        .from('conversation_history')
        .select(`
            *,
            companions:companion_id (id, name, subject, topic, duration)
        `)
        .eq('id', conversationId)
        .eq('user_id', userId)
        .single();

    if (error) throw new Error(error.message);

    return data;
};

export const deleteConversation = async (conversationId: string, path: string) => {
    const { userId } = await auth();
    if (!userId) throw new Error('User not authenticated');

    // âœ… Check access
    const hasAccess = await hasConversationHistoryAccess();
    if (!hasAccess) {
        throw new Error('Access denied: Upgrade to Core or Pro plan');
    }

    const supabase = createSupabaseClient();

    const { data, error } = await supabase
        .from('conversation_history')
        .delete()
        .eq('id', conversationId)
        .eq('user_id', userId);

    if (error) throw new Error(error.message);

    revalidatePath(path);
    return data;
};

export const getConversationStats = async () => {
    const { userId } = await auth();
    if (!userId) throw new Error('User not authenticated');

    // âœ… Check access
    const hasAccess = await hasConversationHistoryAccess();
    if (!hasAccess) {
        return {
            totalConversations: 0,
            totalDuration: 0,
            averageDuration: 0,
            uniqueCompanions: 0,
        };
    }

    const supabase = createSupabaseClient();

    const { data, error } = await supabase
        .from('conversation_history')
        .select('duration, created_at, companion_id')
        .eq('user_id', userId)
        .order('created_at', { ascending: false }); // âœ… Descending order

    if (error) throw new Error(error.message);

    // Calculate statistics
    const totalConversations = data.length;
    const totalDuration = data.reduce((sum, conv) => sum + (conv.duration || 0), 0);
    const uniqueCompanions = new Set(data.map(conv => conv.companion_id)).size;

    return {
        totalConversations,
        totalDuration,
        averageDuration: totalConversations > 0 ? Math.round(totalDuration / totalConversations) : 0,
        uniqueCompanions,
    };
};

// ==================== PREMIUM FEATURES (Core/Pro Only) ====================

// Check if user has access to premium features (recaps, reports)
// Free (3_companion_limit) = No access
// Core (10_companion_limit) = Has access
// Pro (unlimited/pro plan) = Has access
export const hasPremiumFeatureAccess = async () => {
    const { has } = await auth();

    // Pro users (unlimited companions) have access
    if (has({ plan: 'pro' })) return true;

    // Core users (10 companion limit) have access
    if (has({ feature: "10_companion_limit" })) return true;

    // Free users (3 companion limit) don't have access
    return false;
};

// ==================== MONTHLY REPORTS ====================

export const generateMonthlyReport = async (month: number, year: number) => {
    const { userId } = await auth();
    if (!userId) throw new Error('User not authenticated');

    const hasAccess = await hasPremiumFeatureAccess();
    if (!hasAccess) throw new Error('Upgrade to Core or Pro for monthly reports');

    const supabase = createSupabaseClient();

    // Get all conversations for the month
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0, 23, 59, 59);

    const { data: conversations, error: convError } = await supabase
        .from('conversation_history')
        .select(`*, companions:companion_id (subject, duration, topic, name)`)
        .eq('user_id', userId)
        .gte('created_at', startDate.toISOString())
        .lte('created_at', endDate.toISOString());

    if (convError) throw new Error(convError.message);

    // Calculate statistics with detailed subject tracking
    const totalSessions = conversations.length;
    const totalDuration = conversations.reduce((sum, c) => sum + (c.duration || 0), 0);

    const subjectsStudied: Record<string, {
        sessions: number;
        totalDuration: number;
        expectedDuration: number;
        companions: Set<string>;
    }> = {};

    const companionsUsed = new Set<string>();

    conversations.forEach(conv => {
        const subject = conv.companions?.subject;
        const companionDuration = conv.companions?.duration || 0; // Expected duration in minutes
        const actualDuration = conv.duration || 0; // Actual duration in seconds

        if (subject) {
            if (!subjectsStudied[subject]) {
                subjectsStudied[subject] = {
                    sessions: 0,
                    totalDuration: 0,
                    expectedDuration: 0,
                    companions: new Set(),
                };
            }
            subjectsStudied[subject].sessions += 1;
            subjectsStudied[subject].totalDuration += actualDuration;
            subjectsStudied[subject].expectedDuration += companionDuration * 60; // Convert to seconds
            subjectsStudied[subject].companions.add(conv.companions.name);
        }
        companionsUsed.add(conv.companion_id);
    });

    // Convert to serializable format
    const subjectsData: Record<string, any> = {};
    Object.entries(subjectsStudied).forEach(([subject, data]) => {
        const completionPercentage = data.expectedDuration > 0
            ? Math.round((data.totalDuration / data.expectedDuration) * 100)
            : 100;

        subjectsData[subject] = {
            sessions: data.sessions,
            totalDuration: data.totalDuration,
            expectedDuration: data.expectedDuration,
            completionPercentage,
            companions: Array.from(data.companions),
        };
    });

    // Calculate insights for strengths and areas for improvement
    const strengths: string[] = [];
    const areasForImprovement: string[] = [];

    // Identify strengths (>80% completion or high engagement)
    Object.entries(subjectsData).forEach(([subject, data]) => {
        if (data.completionPercentage >= 80) {
            strengths.push(`Strong engagement in ${subject} with ${data.completionPercentage}% completion`);
        }
        if (data.sessions >= 3) {
            strengths.push(`Consistent practice in ${subject} (${data.sessions} sessions)`);
        }
    });

    // Identify areas for improvement (<50% completion or low session count)
    Object.entries(subjectsData).forEach(([subject, data]) => {
        if (data.completionPercentage < 50 && data.sessions > 0) {
            areasForImprovement.push(`Complete more ${subject} sessions (currently ${data.completionPercentage}%)`);
        }
    });

    // Add general improvements if no specific ones
    if (areasForImprovement.length === 0 && totalSessions > 0) {
        areasForImprovement.push('Try exploring new subjects to diversify learning');
    }

    const reportData = {
        totalSessions,
        totalDuration,
        averageDuration: totalSessions > 0 ? Math.round(totalDuration / totalSessions) : 0,
        subjectsStudied: subjectsData,
        companionsUsed: Array.from(companionsUsed),
        mostStudiedSubject: Object.entries(subjectsData).sort((a, b) => b[1].sessions - a[1].sessions)[0]?.[0],
        strengths,
        areasForImprovement,
    };

    // Save report - for backwards compatibility, keep old format too
    const simpleSubjects: Record<string, number> = {};
    Object.entries(subjectsData).forEach(([subject, data]) => {
        simpleSubjects[subject] = data.sessions;
    });

    const { data, error } = await supabase
        .from('monthly_reports')
        .upsert({
            user_id: userId,
            month,
            year,
            total_sessions: totalSessions,
            total_duration: totalDuration,
            subjects_studied: simpleSubjects,
            companions_used: Array.from(companionsUsed),
            strengths, // âœ… Now populated
            areas_for_improvement: areasForImprovement, // âœ… Now populated
            report_data: reportData,
        }, { onConflict: 'user_id,month,year' })
        .select()
        .single();

    if (error) throw new Error(error.message);
    return data;
};

export const getMonthlyReport = async (month: number, year: number) => {
    const { userId } = await auth();
    if (!userId) throw new Error('User not authenticated');

    const hasAccess = await hasPremiumFeatureAccess();
    if (!hasAccess) throw new Error('Upgrade to Core or Pro for monthly reports');

    const supabase = createSupabaseClient();

    const { data, error } = await supabase
        .from('monthly_reports')
        .select()
        .eq('user_id', userId)
        .eq('month', month)
        .eq('year', year)
        .single();

    if (error && error.code !== 'PGRST116') throw new Error(error.message);
    return data;
};

// ==================== LEARNING REMINDERS (Pro Only) ====================

export const saveLearningReminders = async ({
                                                enabled,
                                                time,
                                                frequency,
                                                customDays,
                                            }: {
    enabled: boolean;
    time: string;
    frequency: 'daily' | 'weekdays' | 'custom';
    customDays?: string[];
}) => {
    const { userId, has } = await auth();
    if (!userId) throw new Error('User not authenticated');

    // Check if user is Pro
    const isProUser = has({ plan: 'pro' });
    if (!isProUser) throw new Error('Daily reminders are only available for Pro users');

    const supabase = createSupabaseClient();

    const { data, error } = await supabase
        .from('learning_reminders')
        .upsert({
            user_id: userId,
            enabled,
            reminder_time: time,
            frequency,
            custom_days: customDays,
        }, { onConflict: 'user_id' })
        .select()
        .single();

    if (error) throw new Error(error.message);
    return data;
};

export const getLearningReminders = async () => {
    const { userId, has } = await auth();
    if (!userId) throw new Error('User not authenticated');

    // Check if user is Pro
    const isProUser = has({ plan: 'pro' });
    if (!isProUser) return null;

    const supabase = createSupabaseClient();

    const { data, error } = await supabase
        .from('learning_reminders')
        .select()
        .eq('user_id', userId)
        .single();

    if (error && error.code !== 'PGRST116') throw new Error(error.message);
    return data;
};

export const getAllMonthlyReports = async () => {
    const { userId } = await auth();
    if (!userId) throw new Error('User not authenticated');

    const hasAccess = await hasPremiumFeatureAccess();
    if (!hasAccess) return [];

    const supabase = createSupabaseClient();

    const { data, error } = await supabase
        .from('monthly_reports')
        .select()
        .eq('user_id', userId)
        .order('year', { ascending: false })
        .order('month', { ascending: false });

    if (error) throw new Error(error.message);
    return data;
};

// ==================== SESSION RECAPS ====================

export const generateSessionRecap = async (conversationId: string) => {
    const { userId } = await auth();
    if (!userId) throw new Error('User not authenticated');

    const hasAccess = await hasPremiumFeatureAccess();
    if (!hasAccess) throw new Error('Upgrade to Core or Pro for session recaps');

    const supabase = createSupabaseClient();

    // Get conversation
    const { data: conversation, error: convError } = await supabase
        .from('conversation_history')
        .select('*, companions:companion_id (*)')
        .eq('id', conversationId)
        .eq('user_id', userId)
        .single();

    if (convError) throw new Error(convError.message);

    // Here you would integrate with AI to generate recap
    // For now, we'll create a basic recap from the conversation
    const messages = conversation.messages as Array<{role: string; content: string}>;
    const keyPoints = messages
        .filter(m => m.role === 'assistant')
        .slice(0, 3)
        .map(m => m.content.substring(0, 100));

    const summary = `Session on ${conversation.companions.topic} completed. ${messages.length} messages exchanged.`;

    const { data, error } = await supabase
        .from('session_recaps')
        .insert({
            conversation_id: conversationId,
            user_id: userId,
            companion_id: conversation.companion_id,
            key_points: keyPoints,
            summary,
            next_steps: ['Review key concepts', 'Practice with examples'],
            difficulty_level: 'medium',
        })
        .select()
        .single();

    if (error) throw new Error(error.message);
    return data;
};

export const getSessionRecap = async (conversationId: string) => {
    const { userId } = await auth();
    if (!userId) throw new Error('User not authenticated');

    const hasAccess = await hasPremiumFeatureAccess();
    if (!hasAccess) throw new Error('Upgrade to Core or Pro for session recaps');

    const supabase = createSupabaseClient();

    const { data, error } = await supabase
        .from('session_recaps')
        .select('*, companions:companion_id (*)')
        .eq('conversation_id', conversationId)
        .eq('user_id', userId)
        .single();

    if (error && error.code !== 'PGRST116') throw new Error(error.message);
    return data;
};

types
index.d.ts
// type User = {
//   name: string;
//   email: string;
//   image?: string;
//   accountId: string;
// };

enum Subject {
  maths = "maths",
  language = "language",
  science = "science",
  history = "history",
  coding = "coding",
  geography = "geography",
  economics = "economics",
  finance = "finance",
  business = "business",
}

type Companion = Models.DocumentList<Models.Document> & {
  $id: string;
  name: string;
  subject: Subject;
  topic: string;
  duration: number;
  bookmarked: boolean;
};

interface CreateCompanion {
  name: string;
  subject: string;
  topic: string;
  voice: string;
  style: string;
  duration: number;
}

interface GetAllCompanions {
  limit?: number;
  page?: number;
  subject?: string | string[];
  topic?: string | string[];
}

interface BuildClient {
  key?: string;
  sessionToken?: string;
}

interface CreateUser {
  email: string;
  name: string;
  image?: string;
  accountId: string;
}

interface SearchParams {
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>;
}

interface Avatar {
  userName: string;
  width: number;
  height: number;
  className?: string;
}


interface SavedMessage {
  role: "user" | "system" | "assistant";
  content: string;
}

interface CompanionComponentProps {
  companionId: string;
  subject: string;
  topic: string;
  name: string;
  userName: string;
  userImage: string;
  voice: string;
  style: string;
}

vapi.d.ts
enum MessageTypeEnum {
  TRANSCRIPT = "transcript",
  FUNCTION_CALL = "function-call",
  FUNCTION_CALL_RESULT = "function-call-result",
  ADD_MESSAGE = "add-message",
}

enum MessageRoleEnum {
  USER = "user",
  SYSTEM = "system",
  ASSISTANT = "assistant",
}

enum TranscriptMessageTypeEnum {
  PARTIAL = "partial",
  FINAL = "final",
}

interface BaseMessage {
  type: MessageTypeEnum;
}

interface TranscriptMessage extends BaseMessage {
  type: MessageTypeEnum.TRANSCRIPT;
  role: MessageRoleEnum;
  transcriptType: TranscriptMessageTypeEnum;
  transcript: string;
}

interface FunctionCallMessage extends BaseMessage {
  type: MessageTypeEnum.FUNCTION_CALL;
  functionCall: {
    name: string;
    parameters: unknown;
  };
}

interface FunctionCallResultMessage extends BaseMessage {
  type: MessageTypeEnum.FUNCTION_CALL_RESULT;
  functionCallResult: {
    forwardToClientEnabled?: boolean;
    result: unknown;
    [a: string]: unknown;
  };
}

type Message =
  | TranscriptMessage
  | FunctionCallMessage
  | FunctionCallResultMessage;

.env.local
#Clerk Auth
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=''
CLERK_SECRET_KEY=''

#Clerk - Custom Auth
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL=/
NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL=/

#Supabase - DB
NEXT_PUBLIC_SUPABASE_URL=''
NEXT_PUBLIC_SUPABASE_ANON_KEY=''

#Vapi
NEXT_PUBLIC_VAPI_WEB_TOKEN=''

#Sentry
SENTRY_AUTH_TOKEN=''
